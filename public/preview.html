<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8">
<title>VidGen</title>
<meta name="viewport" content="width=device-width, initial-scale=1">

<style>
body{
  background:#0f172a;
  color:#e5e7eb;
  font-family:system-ui;
  margin:0;
  padding:20px;
  display:flex;
  justify-content:center;
}
.app{
  max-width:1200px;
  width:100%;
  background:#020617;
  padding:20px;
  border-radius:16px;
}
.grid{
  display:grid;
  grid-template-columns:1.1fr 0.9fr;
  gap:20px;
}
@media(max-width:900px){.grid{grid-template-columns:1fr}}

.panel{
  border:1px solid #1e293b;
  border-radius:14px;
  padding:16px;
}

label{
  font-size:13px;
  color:#94a3b8;
  margin-top:12px;
  display:block;
}

input,textarea,select{
  width:100%;
  margin-top:6px;
  padding:10px;
  background:#020617;
  border:1px solid #334155;
  border-radius:8px;
  color:#e5e7eb;
}

button{
  margin-top:16px;
  padding:12px;
  background:#38bdf8;
  color:#020617;
  border:none;
  border-radius:10px;
  font-weight:700;
  cursor:pointer;
}
button.secondary{
  background:#1e293b;
  color:#e5e7eb;
}

.preview{
  background:#000;
  border-radius:14px;
  overflow:hidden;
  border:1px solid #1e293b;
  margin-bottom:12px;
}
.preview img,.preview video{
  width:100%;
  height:100%;
  object-fit:contain;
}

/* ================= MODAL ================= */
#songModal{
  position:fixed;
  inset:0;
  background:rgba(0,0,0,.75);
  display:none;
  align-items:center;
  justify-content:center;
  z-index:1000;
}
#songModal .box{
  width:95%;
  max-width:900px;
  background:#020617;
  border-radius:16px;
  padding:20px;
  border:1px solid #1e293b;
}

.song-list{
  max-height:260px;
  overflow:auto;
  margin-top:10px;
  border:1px solid #1e293b;
  border-radius:12px;
}
.song-item{
  display:flex;
  gap:10px;
  padding:8px;
  cursor:pointer;
  border-bottom:1px solid #1e293b;
}
.song-item:hover{background:#020617}
.song-item img{
  width:48px;
  height:48px;
  border-radius:8px;
}

.clip-info{
  font-size:12px;
  color:#94a3b8;
  margin-top:6px;
}
</style>
</head>

<body>
<div class="app">
<div class="grid">

<!-- LEFT PANEL -->
<div class="panel">

<label>User Name</label>
<input id="username">

<label>User Profile Image URL</label>
<input id="userProfileImage">

<label>Aspect Ratio</label>
<select id="ratio">
  <option value="1:1">1:1</option>
  <option value="9:16">9:16</option>
  <option value="16:9" selected>16:9</option>
</select>

<label>Main Text</label>
<textarea id="text">HELLO WORLD</textarea>

<label>Text Color</label>
<input type="color" id="textColor" value="#ffffff">

<label>Background Color</label>
<input type="color" id="cardColor" value="#000000">

<hr style="margin:18px 0;border-color:#1e293b">

<label>Song</label>
<button class="secondary" onclick="openModal()">Search & Select Song</button>

<label>Song Title</label>
<input id="songTitle" readonly>

<label>Artist</label>
<input id="artist" readonly>

<label>Song Image URL</label>
<input id="songImage" readonly>

<label>Music URL (160kbps)</label>
<input id="musicUrl" readonly>

<input type="hidden" id="clipStart">
<input type="hidden" id="clipEnd">

<button onclick="generate()">Generate & Download</button>
</div>

<!-- RIGHT PANEL -->
<div class="panel">
  <div class="preview"><img id="svgPreview"></div>
  <div class="preview"><video id="videoPreview" controls></video></div>
</div>

</div>
</div>

<canvas id="canvas" style="display:none"></canvas>

<!-- ================= SONG MODAL ================= -->
<div id="songModal">
  <div class="box">

    <h3>Select Song & Clip</h3>

    <div style="display:flex;gap:10px">
      <input id="modalSearch" placeholder="Search song or artist">
      <button onclick="searchSongs()">Search</button>
    </div>

    <div class="song-list" id="songResults"></div>

    <div id="clipBox" style="display:none;margin-top:14px">
      <audio id="previewAudio" controls style="width:100%"></audio>

      <label>Clip Start</label>
      <input type="range" id="mStart" min="0" step="0.1">

      <label>Clip End</label>
      <input type="range" id="mEnd" min="10" step="0.1">

      <div class="clip-info" id="clipInfo"></div>

      <button onclick="confirmSong()">Confirm Song</button>
    </div>

    <div style="display:flex;justify-content:space-between;margin-top:10px">
      <button onclick="prevPage()">◀ Prev</button>
      <button onclick="nextPage()">Next ▶</button>
    </div>

    <button class="secondary" onclick="closeModal()">Close</button>
  </div>
</div>

<script>
/* ================= MODAL STATE ================= */
let page=0;
let selectedSong=null;
let audioDuration=0;

/* ================= MODAL CONTROL ================= */
function openModal(){
  songModal.style.display="flex";
  songResults.innerHTML="";
  clipBox.style.display="none";
}
function closeModal(){
  songModal.style.display="none";
}

/* ================= SEARCH ================= */
async function searchSongs(){
  page=0;
  loadSongs();
}
async function loadSongs(){
  const q = modalSearch.value || "tamil";
  songResults.innerHTML="Loading...";
  const api =
`https://saavn.sumit.co/api/search/songs?query=${encodeURIComponent(q)}&page=${page}&limit=50`;
  const res = await fetch(api);
  const json = await res.json();
  const list = json.data.results;

  songResults.innerHTML="";
  list.forEach(s=>{
    const d=document.createElement("div");
    d.className="song-item";
    d.innerHTML=`
      <img src="${s.image[1].url}">
      <div>
        <b>${s.name}</b><br>
        <small>${s.primaryArtists}</small>
      </div>`;
    d.onclick=()=>selectSong(s);
    songResults.appendChild(d);
  });
}
function nextPage(){page++;loadSongs();}
function prevPage(){if(page>0){page--;loadSongs();}}

/* ================= SONG SELECT ================= */
function selectSong(song){
  selectedSong=song;
  const audio160=song.downloadUrl.find(a=>a.quality==="160kbps");
  previewAudio.src=audio160.url;

  previewAudio.onloadedmetadata=()=>{
    audioDuration=previewAudio.duration;
    mStart.max=audioDuration-10;
    mEnd.max=audioDuration;
    mStart.value=0;
    mEnd.value=10;
    updateClip();
    clipBox.style.display="block";
  };
}

/* ================= CLIP CUT ================= */
mStart.oninput=mEnd.oninput=()=>{
  let s=+mStart.value;
  let e=+mEnd.value;
  if(e-s<10) e=s+10;
  if(e-s>30) e=s+30;
  mEnd.value=Math.min(e,audioDuration);
  updateClip();
};
function updateClip(){
  clipInfo.textContent=
    `Duration: ${(mEnd.value-mStart.value).toFixed(1)}s (10–30s)`;
}

/* ================= CONFIRM ================= */
function confirmSong(){
  const audio160=selectedSong.downloadUrl.find(a=>a.quality==="160kbps");
  songTitle.value=selectedSong.name;
  artist.value=selectedSong.primaryArtists;
  songImage.value=selectedSong.image.at(-1).url;
  musicUrl.value=audio160.url;
  clipStart.value=mStart.value;
  clipEnd.value=mEnd.value;
  closeModal();
}

/* ================= BASE64 ================= */
async function toBase64(url){
  if(!url) return "";
  const r=await fetch(url);
  const b=await r.blob();
  return await new Promise(res=>{
    const fr=new FileReader();
    fr.onload=()=>res(fr.result);
    fr.readAsDataURL(b);
  });
}

/* ================= GENERATE ================= */
async function generate(){
  const start=+clipStart.value;
  const end=+clipEnd.value;
  if(end-start<10||end-start>30){
    alert("Clip must be 10–30 seconds");
    return;
  }

  const payload={
    ratio:ratio.value,
    text:text.value,
    textColor:textColor.value,
    cardColor:cardColor.value,
    username:username.value,
    userProfileImageBase64:await toBase64(userProfileImage.value),
    songTitle:songTitle.value,
    artist:artist.value,
    songImageBase64:await toBase64(songImage.value),
    musicUrl:musicUrl.value,
    clipStart:start,
    clipEnd:end
  };

  const r=await fetch("/api/generate-card",{
    method:"POST",
    headers:{"Content-Type":"application/json"},
    body:JSON.stringify(payload)
  });
  const data=await r.json();
  if(!data.success){alert("API failed");return;}

  const svgData="data:image/svg+xml;base64,"+
    btoa(unescape(encodeURIComponent(data.svg)));
  svgPreview.src=svgData;

  canvas.width=data.width;
  canvas.height=data.height;
  const ctx=canvas.getContext("2d");
  const img=new Image();
  img.src=svgData;
  await img.decode();

  const audio=new Audio(data.audio);
  audio.currentTime=data.clipStart;

  const stream=canvas.captureStream(30);
  const ac=new AudioContext();
  const src=ac.createMediaElementSource(audio);
  const dest=ac.createMediaStreamDestination();
  src.connect(dest);src.connect(ac.destination);
  stream.addTrack(dest.stream.getAudioTracks()[0]);

  const rec=new MediaRecorder(stream,{mimeType:"video/webm"});
  const chunks=[];
  rec.ondataavailable=e=>chunks.push(e.data);
  rec.onstop=()=>{
    const blob=new Blob(chunks,{type:"video/webm"});
    const url=URL.createObjectURL(blob);
    videoPreview.src=url;
    const a=document.createElement("a");
    a.href=url;
    a.download="video.webm";
    a.click();
  };

  rec.start();
  audio.play();

  const loop=setInterval(()=>{
    ctx.drawImage(img,0,0,canvas.width,canvas.height);
  },33);

  setTimeout(()=>{
    clearInterval(loop);
    rec.stop();
    audio.pause();
    ac.close();
  },(end-start)*1000);
}
</script>
</body>
</html>
