<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<title>VidGen</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0" />

<style>
  * { box-sizing: border-box; font-family: system-ui, -apple-system; }

  body {
    margin: 0;
    background: #0f172a;
    color: #e5e7eb;
    display: flex;
    justify-content: center;
    padding: 20px;
  }

  .app {
    width: 100%;
    max-width: 1100px;
    background: #020617;
    border-radius: 16px;
    padding: 20px;
    box-shadow: 0 20px 60px rgba(0,0,0,0.4);
  }

  header {
    text-align: center;
    margin-bottom: 20px;
  }

  .grid {
    display: grid;
    grid-template-columns: 1fr 1fr;
    gap: 20px;
  }

  @media (max-width: 900px) {
    .grid { grid-template-columns: 1fr; }
  }

  .panel {
    border: 1px solid #1e293b;
    border-radius: 14px;
    padding: 16px;
  }

  label {
    display: block;
    font-size: 13px;
    color: #94a3b8;
    margin-top: 12px;
  }

  textarea, input {
    width: 100%;
    margin-top: 6px;
    padding: 10px;
    background: #020617;
    border: 1px solid #334155;
    border-radius: 8px;
    color: #e5e7eb;
  }

  textarea { min-height: 80px; }

  .row { display: flex; gap: 10px; }
  .row input { flex: 1; }

  button {
    width: 100%;
    margin-top: 16px;
    padding: 12px;
    background: #38bdf8;
    color: #020617;
    border: none;
    border-radius: 10px;
    font-weight: 700;
    cursor: pointer;
  }

  .preview-box {
    aspect-ratio: 16 / 9;
    background: #000;
    border-radius: 14px;
    overflow: hidden;
    border: 1px solid #1e293b;
  }

  .preview-box img,
  .preview-box video {
    width: 100%;
    height: 100%;
    object-fit: contain;
  }

  .hint {
    font-size: 12px;
    color: #94a3b8;
    margin-top: 4px;
  }
</style>
</head>

<body>

<div class="app">
  <header>
    <h1>VidGen</h1>
    <p>SVG Card + Audio Clip → Video</p>
  </header>

  <div class="grid">

    <!-- INPUT PANEL -->
    <div class="panel">

      <label>Main Text</label>
      <textarea id="text">HELLO WORLD</textarea>

      <label>Text Color</label>
      <input type="color" id="textColor" value="#ffffff">

      <label>Card Background</label>
      <input type="color" id="cardColor" value="#000000">

      <label>Song Title</label>
      <input id="songTitle" placeholder="Song name">

      <label>Artist</label>
      <input id="artist" placeholder="Artist name">

      <label>Song Image URL</label>
      <input id="songImage" placeholder="https://example.com/cover.jpg">

      <label>Music URL</label>
      <input id="musicUrl" placeholder="https://example.com/song.mp3">

      <label>Audio Clip (seconds)</label>
      <div class="row">
        <input id="clipStart" type="number" min="0" step="0.1" placeholder="Start (sec)">
        <input id="clipEnd" type="number" min="0" step="0.1" placeholder="End (sec)">
      </div>
      <div class="hint">Example: start 30, end 45 → 15s clip</div>

      <button onclick="generate()">Generate</button>
    </div>

    <!-- PREVIEW PANEL -->
    <div class="panel">
      <label>SVG Preview</label>
      <div class="preview-box">
        <img id="svgPreview">
      </div>

      <label>Video Preview</label>
      <div class="preview-box">
        <video id="videoPreview" controls></video>
      </div>
    </div>

  </div>
</div>

<canvas id="canvas" width="1920" height="1080" style="display:none"></canvas>

<script>
async function generate() {
  const start = parseFloat(clipStart.value || 0);
  const end = parseFloat(clipEnd.value || 0);
  const duration = Math.max(0, end - start);

  if (!musicUrl.value || duration <= 0) {
    alert("Please provide music URL and valid clip times");
    return;
  }

  const payload = {
    text: text.value,
    textColor: textColor.value,
    cardColor: cardColor.value,
    songTitle: songTitle.value,
    artist: artist.value,
    songImage: songImage.value,
    musicUrl: musicUrl.value,
    clipStart: start,
    clipDuration: duration
  };

  const res = await fetch("/api/generate-card", {
    method: "POST",
    headers: { "Content-Type": "application/json" },
    body: JSON.stringify(payload)
  });

  const raw = await res.text();
  let data;
  try { data = JSON.parse(raw); }
  catch { return alert("Server error"); }

  if (!data.success) return alert("API failed");

  // SVG preview
  const svgData =
    "data:image/svg+xml;base64," +
    btoa(unescape(encodeURIComponent(data.svg)));

  svgPreview.src = svgData;

  // Video generation
  const canvas = document.getElementById("canvas");
  const ctx = canvas.getContext("2d");
  const img = new Image();
  img.src = svgData;
  await img.decode();

  const audio = new Audio(data.audio);
  audio.currentTime = data.clipStart;

  const stream = canvas.captureStream(30);
  const ac = new AudioContext();
  const src = ac.createMediaElementSource(audio);
  const dest = ac.createMediaStreamDestination();
  src.connect(dest);
  src.connect(ac.destination);
  stream.addTrack(dest.stream.getAudioTracks()[0]);

  const recorder = new MediaRecorder(stream);
  const chunks = [];
  recorder.ondataavailable = e => chunks.push(e.data);
  recorder.onstop = () => {
    videoPreview.src = URL.createObjectURL(new Blob(chunks));
  };

  recorder.start();
  audio.play();

  const drawLoop = setInterval(() => {
    ctx.drawImage(img, 0, 0, canvas.width, canvas.height);
  }, 33);

  setTimeout(() => {
    clearInterval(drawLoop);
    recorder.stop();
    audio.pause();
    ac.close();
  }, duration * 1000);
}
</script>

</body>
</html>
