<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<title>VidGen</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0" />

<style>
  * {
    box-sizing: border-box;
    font-family: system-ui, -apple-system;
  }

  body {
    margin: 0;
    background: #0f172a;
    color: #e5e7eb;
    display: flex;
    justify-content: center;
    padding: 20px;
  }

  .app {
    width: 100%;
    max-width: 1100px;
    background: #020617;
    border-radius: 16px;
    padding: 20px;
    box-shadow: 0 20px 60px rgba(0,0,0,0.4);
  }

  header {
    text-align: center;
    margin-bottom: 20px;
  }

  header h1 {
    margin: 0;
    font-size: 26px;
  }

  .grid {
    display: grid;
    grid-template-columns: 1fr 1fr;
    gap: 20px;
  }

  @media (max-width: 900px) {
    .grid { grid-template-columns: 1fr; }
  }

  .panel {
    border: 1px solid #1e293b;
    border-radius: 14px;
    padding: 16px;
  }

  label {
    display: block;
    font-size: 13px;
    color: #94a3b8;
    margin-top: 12px;
  }

  textarea, input {
    width: 100%;
    margin-top: 6px;
    padding: 10px;
    background: #020617;
    border: 1px solid #334155;
    border-radius: 8px;
    color: #e5e7eb;
  }

  textarea { min-height: 80px; }

  button {
    margin-top: 14px;
    padding: 10px;
    background: #38bdf8;
    color: #020617;
    border: none;
    border-radius: 8px;
    font-weight: 700;
    cursor: pointer;
  }

  .btn-secondary {
    background: #1e293b;
    color: #e5e7eb;
  }

  .preview-box {
    aspect-ratio: 16 / 9;
    background: #000;
    border-radius: 14px;
    overflow: hidden;
    border: 1px solid #1e293b;
  }

  .preview-box img,
  .preview-box video {
    width: 100%;
    height: 100%;
    object-fit: contain;
  }

  .row {
    display: flex;
    gap: 10px;
  }

  .row button {
    flex: 1;
  }
</style>
</head>

<body>

<div class="app">
  <header>
    <h1>VidGen</h1>
    <p>Card → SVG → Video</p>
  </header>

  <div class="grid">

    <!-- INPUT PANEL -->
    <div class="panel">

      <label>Main Text</label>
      <textarea id="text">HELLO WORLD</textarea>

      <label>Text Color</label>
      <input type="color" id="textColor" value="#ffffff">

      <label>Card Background</label>
      <input type="color" id="cardColor" value="#000000">

      <label>Song Title</label>
      <input id="songTitle" placeholder="Song name">

      <label>Artist</label>
      <input id="artist" placeholder="Artist name">

      <label>Song Image URL</label>
      <input id="songImage" placeholder="https://example.com/cover.jpg">

      <label>Music URL</label>
      <input id="musicUrl" placeholder="https://example.com/music.mp3">

      <button onclick="generate()">Generate</button>

      <div class="row">
        <button class="btn-secondary" onclick="copySVG()">Copy SVG</button>
        <button class="btn-secondary" onclick="copyVideo()">Copy Video URL</button>
      </div>

    </div>

    <!-- PREVIEW PANEL -->
    <div class="panel">

      <label>SVG Preview</label>
      <div class="preview-box">
        <img id="svgPreview">
      </div>

      <label>Video Preview</label>
      <div class="preview-box">
        <video id="videoPreview" controls></video>
      </div>

    </div>

  </div>
</div>

<canvas id="canvas" width="1920" height="1080" style="display:none"></canvas>

<script>
let LAST_SVG = "";
let LAST_VIDEO_URL = "";

async function generate() {
  const payload = {
    text: text.value,
    textColor: textColor.value,
    cardColor: cardColor.value,
    musicUrl: musicUrl.value
  };

  const res = await fetch("/api/generate-card", {
    method: "POST",
    headers: { "Content-Type": "application/json" },
    body: JSON.stringify(payload)
  });

  const raw = await res.text();
  let data;
  try { data = JSON.parse(raw); }
  catch { return alert("Invalid server response"); }

  if (!data.success) return alert("API error");

  // ----- Build SVG with song metadata -----
  LAST_SVG = `
<svg xmlns="http://www.w3.org/2000/svg" width="1920" height="1080">
  <rect width="100%" height="100%" fill="${cardColor.value}" />
  <text x="960" y="480" fill="${textColor.value}"
    font-size="90" font-weight="bold"
    text-anchor="middle" dominant-baseline="middle">
    ${escapeHtml(text.value)}
  </text>

  <image href="${songImage.value}" x="80" y="820" width="140" height="140" />

  <text x="250" y="880" fill="#ffffff" font-size="36">${escapeHtml(songTitle.value)}</text>
  <text x="250" y="930" fill="#94a3b8" font-size="28">${escapeHtml(artist.value)}</text>
</svg>`;

  const svgData = "data:image/svg+xml;base64," + btoa(LAST_SVG);
  svgPreview.src = svgData;

  // ----- Video generation -----
  const canvas = document.getElementById("canvas");
  const ctx = canvas.getContext("2d");
  const img = new Image();
  img.src = svgData;
  await img.decode();

  const audio = new Audio(data.audio);
  await audio.play().catch(()=>{});
  audio.pause();

  const stream = canvas.captureStream(30);
  const ac = new AudioContext();
  const src = ac.createMediaElementSource(audio);
  const dest = ac.createMediaStreamDestination();
  src.connect(dest);
  src.connect(ac.destination);
  stream.addTrack(dest.stream.getAudioTracks()[0]);

  const recorder = new MediaRecorder(stream);
  const chunks = [];
  recorder.ondataavailable = e => chunks.push(e.data);
  recorder.onstop = () => {
    const blob = new Blob(chunks);
    LAST_VIDEO_URL = URL.createObjectURL(blob);
    videoPreview.src = LAST_VIDEO_URL;
  };

  recorder.start();
  audio.play();

  const loop = setInterval(() => {
    ctx.drawImage(img, 0, 0, canvas.width, canvas.height);
  }, 33);

  setTimeout(() => {
    clearInterval(loop);
    recorder.stop();
    audio.pause();
    ac.close();
  }, audio.duration * 1000);
}

function copySVG() {
  if (!LAST_SVG) return alert("Generate first");
  navigator.clipboard.writeText(LAST_SVG);
  alert("SVG copied");
}

function copyVideo() {
  if (!LAST_VIDEO_URL) return alert("Generate first");
  navigator.clipboard.writeText(LAST_VIDEO_URL);
  alert("Video URL copied");
}

function escapeHtml(s) {
  return s.replace(/[<>&"]/g, c =>
    ({ "<":"&lt;", ">":"&gt;", "&":"&amp;", "\"":"&quot;" }[c])
  );
}
</script>

</body>
</html>
