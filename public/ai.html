<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>CapCut Video Editor</title>
<meta name="viewport" content="width=device-width, initial-scale=1">
<style>
* {
  box-sizing: border-box;
  margin: 0;
  padding: 0;
}

body {
  background: #1a1a1a;
  color: #e5e7eb;
  font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
  overflow: hidden;
  height: 100vh;
}

.editor-container {
  display: flex;
  flex-direction: column;
  height: 100vh;
}

/* TOP BAR */
.top-bar {
  background: #0a0a0a;
  border-bottom: 1px solid #333;
  padding: 8px 16px;
  display: flex;
  justify-content: space-between;
  align-items: center;
  height: 56px;
}

.logo {
  font-size: 20px;
  font-weight: 700;
  background: linear-gradient(135deg, #00d4ff, #ff00d4);
  -webkit-background-clip: text;
  -webkit-text-fill-color: transparent;
}

.top-actions {
  display: flex;
  gap: 12px;
  align-items: center;
}

.btn {
  padding: 8px 20px;
  border: none;
  border-radius: 8px;
  font-size: 14px;
  font-weight: 600;
  cursor: pointer;
  transition: all 0.2s;
}

.btn-primary {
  background: linear-gradient(135deg, #00d4ff, #0099ff);
  color: #fff;
}

.btn-primary:hover {
  transform: translateY(-1px);
  box-shadow: 0 4px 12px rgba(0, 212, 255, 0.4);
}

.btn-secondary {
  background: #2a2a2a;
  color: #fff;
  border: 1px solid #444;
}

.btn-secondary:hover {
  background: #333;
}

/* MAIN CONTENT */
.main-content {
  display: flex;
  flex: 1;
  overflow: hidden;
}

/* LEFT PANEL */
.left-panel {
  width: 80px;
  background: #0f0f0f;
  border-right: 1px solid #333;
  display: flex;
  flex-direction: column;
  padding: 12px 0;
}

.tool-btn {
  width: 100%;
  padding: 16px 8px;
  background: transparent;
  border: none;
  color: #999;
  cursor: pointer;
  display: flex;
  flex-direction: column;
  align-items: center;
  gap: 4px;
  font-size: 11px;
  transition: all 0.2s;
}

.tool-btn:hover,
.tool-btn.active {
  background: #1a1a1a;
  color: #00d4ff;
}

.tool-icon {
  font-size: 24px;
}

/* CENTER CANVAS AREA */
.canvas-area {
  flex: 1;
  display: flex;
  flex-direction: column;
  background: #161616;
  position: relative;
}

.canvas-controls {
  padding: 12px 16px;
  background: #0f0f0f;
  border-bottom: 1px solid #333;
  display: flex;
  align-items: center;
  gap: 12px;
}

.zoom-controls {
  display: flex;
  align-items: center;
  gap: 8px;
  margin-left: auto;
}

.zoom-btn {
  width: 32px;
  height: 32px;
  background: #2a2a2a;
  border: 1px solid #444;
  border-radius: 6px;
  color: #fff;
  cursor: pointer;
  font-size: 16px;
}

.zoom-btn:hover {
  background: #333;
}

.zoom-level {
  min-width: 60px;
  text-align: center;
  font-size: 13px;
  color: #999;
}

.canvas-viewport {
  flex: 1;
  display: flex;
  align-items: center;
  justify-content: center;
  overflow: auto;
  position: relative;
  background: 
    repeating-linear-gradient(0deg, transparent, transparent 19px, #1a1a1a 19px, #1a1a1a 20px),
    repeating-linear-gradient(90deg, transparent, transparent 19px, #1a1a1a 19px, #1a1a1a 20px);
  background-size: 20px 20px;
}

.canvas-wrapper {
  position: relative;
  transform-origin: center center;
  transition: transform 0.2s;
}

canvas {
  display: block;
  box-shadow: 0 8px 32px rgba(0, 0, 0, 0.8);
  cursor: move;
}

/* ELEMENT HANDLES */
.element-handle {
  position: absolute;
  width: 12px;
  height: 12px;
  background: #00d4ff;
  border: 2px solid #fff;
  border-radius: 50%;
  cursor: pointer;
  transform: translate(-50%, -50%);
  z-index: 100;
}

.handle-tl { cursor: nw-resize; }
.handle-tr { cursor: ne-resize; }
.handle-bl { cursor: sw-resize; }
.handle-br { cursor: se-resize; }
.handle-rotate {
  width: 16px;
  height: 16px;
  background: #ff00d4;
  cursor: grab;
}

/* RIGHT PANEL */
.right-panel {
  width: 340px;
  background: #0f0f0f;
  border-left: 1px solid #333;
  display: flex;
  flex-direction: column;
  max-height: calc(100vh - 56px - 200px);
  overflow-y: auto;
}

.right-panel::-webkit-scrollbar {
  width: 8px;
}

.right-panel::-webkit-scrollbar-track {
  background: #1a1a1a;
}

.right-panel::-webkit-scrollbar-thumb {
  background: #00d4ff;
  border-radius: 4px;
}

.panel-section {
  padding: 16px;
  border-bottom: 1px solid #2a2a2a;
}

.section-title {
  font-size: 13px;
  font-weight: 600;
  color: #fff;
  margin-bottom: 12px;
  text-transform: uppercase;
  letter-spacing: 0.5px;
}

.property-row {
  margin-bottom: 12px;
}

.property-label {
  display: flex;
  justify-content: space-between;
  font-size: 12px;
  color: #999;
  margin-bottom: 6px;
}

.property-value {
  color: #00d4ff;
  font-weight: 600;
}

input[type="range"] {
  width: 100%;
  height: 4px;
  background: #2a2a2a;
  border-radius: 2px;
  outline: none;
  -webkit-appearance: none;
}

input[type="range"]::-webkit-slider-thumb {
  -webkit-appearance: none;
  width: 14px;
  height: 14px;
  background: #00d4ff;
  border-radius: 50%;
  cursor: pointer;
}

input[type="range"]::-moz-range-thumb {
  width: 14px;
  height: 14px;
  background: #00d4ff;
  border-radius: 50%;
  cursor: pointer;
  border: none;
}

input[type="text"],
input[type="number"],
textarea,
select {
  width: 100%;
  padding: 8px 10px;
  background: #1a1a1a;
  color: #e5e7eb;
  border: 1px solid #333;
  border-radius: 6px;
  font-size: 13px;
  font-family: inherit;
}

input:focus,
textarea:focus,
select:focus {
  outline: none;
  border-color: #00d4ff;
}

textarea {
  resize: vertical;
  min-height: 60px;
}

input[type="color"] {
  width: 100%;
  height: 36px;
  padding: 2px;
  border: 1px solid #333;
  border-radius: 6px;
  background: #1a1a1a;
  cursor: pointer;
}

input[type="file"] {
  font-size: 12px;
  padding: 6px;
  cursor: pointer;
}

.preset-grid {
  display: grid;
  grid-template-columns: repeat(2, 1fr);
  gap: 8px;
  margin-top: 8px;
}

.preset-btn {
  padding: 12px 8px;
  background: #1a1a1a;
  border: 1px solid #333;
  border-radius: 6px;
  color: #e5e7eb;
  cursor: pointer;
  font-size: 11px;
  text-align: center;
  transition: all 0.2s;
}

.preset-btn:hover {
  background: #2a2a2a;
  border-color: #00d4ff;
}

.preset-btn small {
  display: block;
  color: #666;
  margin-top: 4px;
}

/* TIMELINE */
.timeline {
  height: 200px;
  background: #0a0a0a;
  border-top: 1px solid #333;
  display: flex;
  flex-direction: column;
}

.timeline-header {
  padding: 8px 16px;
  background: #0f0f0f;
  border-bottom: 1px solid #333;
  display: flex;
  align-items: center;
  gap: 12px;
}

.playback-controls {
  display: flex;
  gap: 8px;
}

.play-btn {
  width: 32px;
  height: 32px;
  background: #00d4ff;
  border: none;
  border-radius: 50%;
  color: #000;
  cursor: pointer;
  font-size: 14px;
  display: flex;
  align-items: center;
  justify-content: center;
}

.play-btn:hover {
  background: #00b8e6;
}

.time-display {
  font-size: 13px;
  color: #999;
  font-variant-numeric: tabular-nums;
  min-width: 100px;
}

.timeline-content {
  flex: 1;
  padding: 12px;
  overflow-x: auto;
  overflow-y: auto;
}

.timeline-tracks {
  display: flex;
  flex-direction: column;
  gap: 8px;
  min-width: max-content;
}

.track {
  background: #1a1a1a;
  border-radius: 6px;
  padding: 8px;
  min-height: 48px;
  display: flex;
  align-items: center;
  gap: 8px;
  position: relative;
}

.track-label {
  font-size: 11px;
  color: #666;
  width: 80px;
  flex-shrink: 0;
}

.track-items {
  flex: 1;
  display: flex;
  gap: 4px;
  position: relative;
}

.track-item {
  background: linear-gradient(135deg, #00d4ff, #0099ff);
  border-radius: 4px;
  padding: 8px 12px;
  font-size: 11px;
  color: #fff;
  cursor: move;
  position: relative;
  min-width: 100px;
  display: flex;
  align-items: center;
  justify-content: space-between;
}

.track-item:hover {
  opacity: 0.9;
}

.track-item.audio {
  background: linear-gradient(135deg, #ff00d4, #ff0080);
}

.layer-list {
  margin-top: 12px;
}

.layer-item {
  background: #1a1a1a;
  border: 2px solid transparent;
  border-radius: 6px;
  padding: 10px;
  margin-bottom: 6px;
  cursor: pointer;
  display: flex;
  justify-content: space-between;
  align-items: center;
  transition: all 0.2s;
}

.layer-item:hover {
  background: #2a2a2a;
}

.layer-item.active {
  border-color: #00d4ff;
  background: #1a2a3a;
}

.layer-badge {
  font-size: 10px;
  padding: 2px 8px;
  background: #2a2a2a;
  border-radius: 4px;
  text-transform: uppercase;
}

.help-text {
  font-size: 11px;
  color: #666;
  margin-top: 4px;
  font-style: italic;
}

.status-toast {
  position: fixed;
  bottom: 220px;
  right: 360px;
  background: #1a1a1a;
  padding: 12px 20px;
  border-radius: 8px;
  border: 1px solid #333;
  display: none;
  box-shadow: 0 4px 12px rgba(0, 0, 0, 0.5);
  z-index: 1000;
}

.status-toast.show {
  display: flex;
  align-items: center;
  gap: 10px;
}

.loader {
  width: 14px;
  height: 14px;
  border: 2px solid #00d4ff;
  border-top-color: transparent;
  border-radius: 50%;
  animation: spin 0.8s linear infinite;
}

@keyframes spin {
  to { transform: rotate(360deg); }
}

.pages-container {
  display: flex;
  gap: 12px;
  padding: 12px 16px;
  background: #0f0f0f;
  border-bottom: 1px solid #333;
  overflow-x: auto;
}

.page-thumb {
  min-width: 80px;
  height: 60px;
  background: #1a1a1a;
  border: 2px solid #333;
  border-radius: 6px;
  cursor: pointer;
  display: flex;
  align-items: center;
  justify-content: center;
  font-size: 11px;
  color: #666;
  transition: all 0.2s;
  position: relative;
}

.page-thumb:hover {
  border-color: #00d4ff;
}

.page-thumb.active {
  border-color: #00d4ff;
  background: #1a2a3a;
  color: #00d4ff;
}

.page-duration {
  position: absolute;
  bottom: 4px;
  right: 4px;
  font-size: 9px;
  background: #000;
  padding: 2px 4px;
  border-radius: 3px;
}

.add-page-btn {
  min-width: 80px;
  height: 60px;
  background: #1a1a1a;
  border: 2px dashed #444;
  border-radius: 6px;
  cursor: pointer;
  display: flex;
  align-items: center;
  justify-content: center;
  font-size: 24px;
  color: #666;
  transition: all 0.2s;
}

.add-page-btn:hover {
  border-color: #00d4ff;
  color: #00d4ff;
}

.audio-waveform {
  width: 100%;
  height: 32px;
  background: #1a1a1a;
  border-radius: 4px;
  margin-top: 8px;
  display: none;
}

.audio-waveform.show {
  display: block;
}
</style>
</head>
<body>

<div class="editor-container">
  <!-- TOP BAR -->
  <div class="top-bar">
    <div class="logo">‚úÇÔ∏è CapCut Editor</div>
    <div class="top-actions">
      <select id="canvasSizeSelect" style="padding: 8px 12px; background: #2a2a2a; border: 1px solid #444; border-radius: 6px; color: #fff; cursor: pointer;">
        <option value="1080,1920">9:16 Portrait</option>
        <option value="1920,1080">16:9 Landscape</option>
        <option value="1080,1080">1:1 Square</option>
        <option value="720,1280">9:16 HD</option>
      </select>
      <button class="btn btn-primary" onclick="exportVideo()">üì§ Export Video</button>
    </div>
  </div>

  <div class="main-content">
    <!-- LEFT TOOLS -->
    <div class="left-panel">
      <button class="tool-btn active">
        <div class="tool-icon">üé¨</div>
        <div>Media</div>
      </button>
      <button class="tool-btn">
        <div class="tool-icon">üìù</div>
        <div>Text</div>
      </button>
      <button class="tool-btn">
        <div class="tool-icon">üéµ</div>
        <div>Audio</div>
      </button>
      <button class="tool-btn">
        <div class="tool-icon">‚ú®</div>
        <div>Effects</div>
      </button>
    </div>

    <!-- CENTER CANVAS -->
    <div class="canvas-area">
      <div class="pages-container" id="pagesContainer">
        <div class="page-thumb active" onclick="switchPage(0)">
          <span>Page 1</span>
          <div class="page-duration">5s</div>
        </div>
        <div class="add-page-btn" onclick="addPage()">+</div>
      </div>

      <div class="canvas-controls">
        <span style="font-size: 12px; color: #999;">Canvas</span>
        <div class="zoom-controls">
          <button class="zoom-btn" onclick="zoomOut()">‚àí</button>
          <div class="zoom-level" id="zoomLevel">100%</div>
          <button class="zoom-btn" onclick="zoomIn()">+</button>
          <button class="zoom-btn" onclick="resetZoom()" title="Reset Zoom">‚äô</button>
        </div>
      </div>

      <div class="canvas-viewport" id="canvasViewport">
        <div class="canvas-wrapper" id="canvasWrapper">
          <canvas id="canvas"></canvas>
        </div>
      </div>
    </div>

    <!-- RIGHT PROPERTIES -->
    <div class="right-panel" id="rightPanel">
      <div class="panel-section">
        <div class="section-title">üìê Canvas Settings</div>
        <div class="preset-grid">
          <div class="preset-btn" onclick="setCanvasSize(1080,1920)">9:16<br><small>1080√ó1920</small></div>
          <div class="preset-btn" onclick="setCanvasSize(1920,1080)">16:9<br><small>1920√ó1080</small></div>
          <div class="preset-btn" onclick="setCanvasSize(1080,1080)">1:1<br><small>1080√ó1080</small></div>
          <div class="preset-btn" onclick="setCanvasSize(720,1280)">HD<br><small>720√ó1280</small></div>
        </div>
        <div class="property-row" style="margin-top: 12px;">
          <div class="property-label">Background Color</div>
          <input type="color" id="bgColor" value="#000000">
        </div>
      </div>

      <div class="panel-section">
        <div class="section-title">üéµ Background Music</div>
        <div class="property-row">
          <input type="url" id="musicUrl" placeholder="Paste audio URL...">
          <p class="help-text">Direct MP3/audio link</p>
        </div>
        <button class="btn btn-secondary" style="width: 100%; margin-top: 8px;" onclick="loadMusic()">Load Music</button>
        <audio id="audioPlayer" controls style="width: 100%; margin-top: 8px; display: none;"></audio>
      </div>

      <div class="panel-section">
        <div class="section-title">üé¨ Layers</div>
        <button class="btn btn-primary" style="width: 100%;" onclick="addLayer()">+ Add Layer (Text + Image)</button>
        <div class="layer-list" id="layersList"></div>
      </div>

      <div id="layerProperties" style="display: none;">
        <div class="panel-section">
          <div class="section-title">üì∏ Background Image</div>
          <input type="file" id="imageUpload" accept="image/*">
          <div class="property-row">
            <div class="property-label">
              <span>Position X</span>
              <span class="property-value" id="imgXVal">0</span>
            </div>
            <input type="range" id="imgX" min="-1000" max="1000" value="0">
          </div>
          <div class="property-row">
            <div class="property-label">
              <span>Position Y</span>
              <span class="property-value" id="imgYVal">0</span>
            </div>
            <input type="range" id="imgY" min="-1000" max="1000" value="0">
          </div>
          <div class="property-row">
            <div class="property-label">
              <span>Scale</span>
              <span class="property-value" id="imgScaleVal">1.0</span>
            </div>
            <input type="range" id="imgScale" min="0.5" max="3" step="0.01" value="1">
          </div>
          <div class="property-row">
            <div class="property-label">
              <span>Opacity</span>
              <span class="property-value" id="imgOpacityVal">100%</span>
            </div>
            <input type="range" id="imgOpacity" min="0" max="1" step="0.01" value="1">
          </div>
        </div>

        <div class="panel-section">
          <div class="section-title">üí¨ Text</div>
          <textarea id="textContent" placeholder="Enter text...">YOUR TEXT</textarea>
          <div class="property-row" style="margin-top: 12px;">
            <div class="property-label">
              <span>Font Size</span>
              <span class="property-value" id="fontSizeVal">64</span>
            </div>
            <input type="range" id="fontSize" min="12" max="200" value="64">
          </div>
          <div class="property-row">
            <div class="property-label">Font Family</div>
            <select id="fontFamily">
              <option value="Arial">Arial</option>
              <option value="Helvetica">Helvetica</option>
              <option value="Impact">Impact</option>
              <option value="Georgia">Georgia</option>
              <option value="'Courier New'">Courier</option>
            </select>
          </div>
          <div class="property-row">
            <div class="property-label">Text Color</div>
            <input type="color" id="textColor" value="#ffffff">
          </div>
          <div class="property-row">
            <div class="property-label">
              <span>Position X</span>
              <span class="property-value" id="textXVal">0</span>
            </div>
            <input type="range" id="textX" min="-1000" max="1000" value="0">
          </div>
          <div class="property-row">
            <div class="property-label">
              <span>Position Y</span>
              <span class="property-value" id="textYVal">0</span>
            </div>
            <input type="range" id="textY" min="-1000" max="1000" value="0">
          </div>
        </div>

        <div class="panel-section">
          <div class="section-title">üé® Transform</div>
          <div class="property-row">
            <div class="property-label">
              <span>Scale</span>
              <span class="property-value" id="layerScaleVal">1.0</span>
            </div>
            <input type="range" id="layerScale" min="0.1" max="3" step="0.01" value="1">
          </div>
          <div class="property-row">
            <div class="property-label">
              <span>Rotation</span>
              <span class="property-value" id="layerRotateVal">0¬∞</span>
            </div>
            <input type="range" id="layerRotate" min="-180" max="180" value="0">
          </div>
          <div class="property-row">
            <div class="property-label">
              <span>Opacity</span>
              <span class="property-value" id="layerOpacityVal">100%</span>
            </div>
            <input type="range" id="layerOpacity" min="0" max="1" step="0.01" value="1">
          </div>
        </div>

        <div class="panel-section">
          <button class="btn btn-secondary" style="width: 100%; background: #dc2626;" onclick="deleteLayer()">üóë Delete Layer</button>
        </div>
      </div>
    </div>
  </div>

  <!-- TIMELINE -->
  <div class="timeline">
    <div class="timeline-header">
      <div class="playback-controls">
        <button class="play-btn" onclick="play()">‚ñ∂</button>
        <button class="btn btn-secondary" style="padding: 6px 12px;" onclick="pause()">‚è∏</button>
        <button class="btn btn-secondary" style="padding: 6px 12px;" onclick="reset()">‚èÆ</button>
      </div>
      <div class="time-display" id="timeDisplay">00:00 / 05:00</div>
      <div style="flex: 1;"></div>
      <input type="number" id="pageDuration" value="5" min="1" max="30" style="width: 80px; padding: 6px 8px; text-align: center;" placeholder="Duration">
      <span style="font-size: 12px; color: #999;">seconds</span>
    </div>
    <div class="timeline-content">
      <div class="timeline-tracks" id="timelineTracks">
        <div class="track">
          <div class="track-label">Video</div>
          <div class="track-items" id="videoTrack"></div>
        </div>
        <div class="track">
          <div class="track-label">Audio</div>
          <div class="track-items" id="audioTrack"></div>
        </div>
      </div>
    </div>
  </div>
</div>

<div class="status-toast" id="statusToast">
  <div class="loader"></div>
  <span id="statusText"></span>
</div>

<script>
const canvas = document.getElementById('canvas');
const ctx = canvas.getContext('2d');
const canvasWrapper = document.getElementById('canvasWrapper');
const audioPlayer = document.getElementById('audioPlayer');

let pages = [{
  layers: [],
  duration: 5
}];

let currentPageIndex = 0;
let activeLayerId = null;
let zoomLevel = 1;
let isPlaying = false;
let currentTime = 0;
let animationId = null;
let isDragging = false;
let dragStartX = 0;
let dragStartY = 0;
let musicLoaded = false;
let audioStartTime = 0;

canvas.width = 1080;
canvas.height = 1920;

// Initialize
redraw();
updateLayersList();
updateTimeline();

// Canvas drag
canvas.addEventListener('mousedown', e => {
  if (!activeLayerId) return;
  const layer = getCurrentPage().layers.find(l => l.id === activeLayerId);
  if (!layer) return;
  
  isDragging = true;
  const rect = canvas.getBoundingClientRect();
  dragStartX = e.clientX - rect.left;
  dragStartY = e.clientY - rect.top;
  canvas.style.cursor = 'grabbing';
});

canvas.addEventListener('mousemove', e => {
  if (!isDragging || !activeLayerId) return;
  
  const layer = getCurrentPage().layers.find(l => l.id === activeLayerId);
  if (!layer) return;
  
  const rect = canvas.getBoundingClientRect();
  const currentX = e.clientX - rect.left;
  const currentY = e.clientY - rect.top;
  
  const deltaX = ((currentX - dragStartX) / rect.width) * canvas.width / zoomLevel;
  const deltaY = ((currentY - dragStartY) / rect.height) * canvas.height / zoomLevel;
  
  layer.x += deltaX;
  layer.y += deltaY;
  
  dragStartX = currentX;
  dragStartY = currentY;
  
  updatePropertyValues();
  redraw();
});

canvas.addEventListener('mouseup', () => {
  isDragging = false;
  canvas.style.cursor = 'move';
});

canvas.addEventListener('mouseleave', () => {
  isDragging = false;
  canvas.style.cursor = 'move';
});

function getCurrentPage() {
  return pages[currentPageIndex];
}

function redraw() {
  const bgColor = document.getElementById('bgColor').value;
  ctx.fillStyle = bgColor;
  ctx.fillRect(0, 0, canvas.width, canvas.height);

  const page = getCurrentPage();
  page.layers.forEach(layer => {
    ctx.save();
    ctx.globalAlpha = layer.opacity;
    ctx.translate(canvas.width / 2 + layer.x, canvas.height / 2 + layer.y);
    ctx.rotate(layer.rotate * Math.PI / 180);
    ctx.scale(layer.scale, layer.scale);

    // Draw image
    if (layer.image) {
      ctx.save();
      ctx.globalAlpha = layer.opacity * layer.imgOpacity;
      ctx.translate(layer.imgX, layer.imgY);
      ctx.scale(layer.imgScale, layer.imgScale);

      const w = canvas.width;
      const h = canvas.height;
      ctx.drawImage(layer.image, -w / 2, -h / 2, w, h);
      ctx.restore();
    }

    // Draw text
    ctx.globalAlpha = layer.opacity;
    ctx.font = `900 ${layer.fontSize}px ${layer.fontFamily}`;
    ctx.textAlign = 'center';
    ctx.textBaseline = 'middle';
    ctx.fillStyle = layer.textColor;
    
    const lines = layer.text.split('\n');
    lines.forEach((line, i) => {
      const yOffset = layer.textY + (i - (lines.length - 1) / 2) * layer.fontSize * 1.2;
      ctx.fillText(line, layer.textX, yOffset);
    });

    ctx.restore();
  });
}

function addLayer() {
  const id = Date.now();
  const layer = {
    id,
    name: `Layer ${getCurrentPage().layers.length + 1}`,
    x: 0,
    y: 0,
    scale: 1,
    rotate: 0,
    opacity: 1,
    image: null,
    imgX: 0,
    imgY: 0,
    imgScale: 1,
    imgOpacity: 1,
    text: 'YOUR TEXT',
    textX: 0,
    textY: 0,
    fontSize: 64,
    fontFamily: 'Arial',
    textColor: '#ffffff'
  };

  getCurrentPage().layers.push(layer);
  selectLayer(id);
  updateLayersList();
  updateTimeline();
  redraw();
}

function selectLayer(id) {
  activeLayerId = id;
  updateLayersList();
  updatePropertyPanel();
}

function deleteLayer() {
  if (!activeLayerId) return;
  const page = getCurrentPage();
  page.layers = page.layers.filter(l => l.id !== activeLayerId);
  activeLayerId = null;
  updateLayersList();
  updatePropertyPanel();
  updateTimeline();
  redraw();
}

function updateLayersList() {
  const container = document.getElementById('layersList');
  const page = getCurrentPage();
  
  container.innerHTML = page.layers.map(layer => `
    <div class="layer-item ${layer.id === activeLayerId ? 'active' : ''}" 
         onclick="selectLayer(${layer.id})">
      <span>${layer.name}</span>
      <span class="layer-badge">layer</span>
    </div>
  `).join('');
}

function updatePropertyPanel() {
  const panel = document.getElementById('layerProperties');
  
  if (!activeLayerId) {
    panel.style.display = 'none';
    return;
  }

  panel.style.display = 'block';
  const layer = getCurrentPage().layers.find(l => l.id === activeLayerId);
  
  const bindings = [
    ['imgX', 'imgX'],
    ['imgY', 'imgY'],
    ['imgScale', 'imgScale'],
    ['imgOpacity', 'imgOpacity'],
    ['textX', 'textX'],
    ['textY', 'textY'],
    ['fontSize', 'fontSize'],
    ['layerScale', 'scale'],
    ['layerRotate', 'rotate'],
    ['layerOpacity', 'opacity']
  ];

  bindings.forEach(([id, prop]) => {
    const el = document.getElementById(id);
    if (!el) return;
    el.value = layer[prop];
    el.oninput = e => {
      layer[prop] = Number(e.target.value);
      updatePropertyValues();
      redraw();
    };
  });

  const simpleBindings = [
    ['textContent', 'text'],
    ['fontFamily', 'fontFamily'],
    ['textColor', 'textColor']
  ];

  simpleBindings.forEach(([id, prop]) => {
    const el = document.getElementById(id);
    if (!el) return;
    el.value = layer[prop];
    el.oninput = e => {
      layer[prop] = e.target.value;
      redraw();
    };
  });

  document.getElementById('imageUpload').onchange = e => {
    const file = e.target.files[0];
    if (!file) return;
    const reader = new FileReader();
    reader.onload = () => {
      const img = new Image();
      img.onload = () => {
        layer.image = img;
        redraw();
      };
      img.src = reader.result;
    };
    reader.readAsDataURL(file);
  };

  updatePropertyValues();
}

function updatePropertyValues() {
  if (!activeLayerId) return;
  const layer = getCurrentPage().layers.find(l => l.id === activeLayerId);
  if (!layer) return;

  const updates = [
    ['imgXVal', layer.imgX],
    ['imgYVal', layer.imgY],
    ['imgScaleVal', layer.imgScale.toFixed(2)],
    ['imgOpacityVal', Math.round(layer.imgOpacity * 100) + '%'],
    ['textXVal', Math.round(layer.textX)],
    ['textYVal', Math.round(layer.textY)],
    ['fontSizeVal', Math.round(layer.fontSize)],
    ['layerScaleVal', layer.scale.toFixed(2)],
    ['layerRotateVal', Math.round(layer.rotate) + '¬∞'],
    ['layerOpacityVal', Math.round(layer.opacity * 100) + '%']
  ];

  updates.forEach(([id, val]) => {
    const el = document.getElementById(id);
    if (el) el.textContent = val;
  });
}

function addPage() {
  pages.push({
    layers: [],
    duration: 5
  });
  updatePagesUI();
  updateTimeline();
}

function switchPage(index) {
  currentPageIndex = index;
  activeLayerId = null;
  updatePagesUI();
  updateLayersList();
  updatePropertyPanel();
  updateTimeline();
  redraw();
}

function updatePagesUI() {
  const container = document.getElementById('pagesContainer');
  const pagesHTML = pages.map((page, i) => `
    <div class="page-thumb ${i === currentPageIndex ? 'active' : ''}" onclick="switchPage(${i})">
      <span>Page ${i + 1}</span>
      <div class="page-duration">${page.duration}s</div>
    </div>
  `).join('');
  
  container.innerHTML = pagesHTML + '<div class="add-page-btn" onclick="addPage()">+</div>';
}

function updateTimeline() {
  const videoTrack = document.getElementById('videoTrack');
  const audioTrack = document.getElementById('audioTrack');
  
  const page = getCurrentPage();
  videoTrack.innerHTML = page.layers.map(layer => `
    <div class="track-item">
      <span>${layer.name}</span>
      <span>${page.duration}s</span>
    </div>
  `).join('');

  if (musicLoaded) {
    audioTrack.innerHTML = `
      <div class="track-item audio">
        <span>üéµ Background Music</span>
        <span>${page.duration}s</span>
      </div>
    `;
  } else {
    audioTrack.innerHTML = '<span style="color: #666; font-size: 11px;">No audio</span>';
  }
}

function loadMusic() {
  const url = document.getElementById('musicUrl').value.trim();
  if (!url) {
    alert('Please enter a music URL');
    return;
  }
  
  audioPlayer.src = url;
  audioPlayer.load();
  audioPlayer.style.display = 'block';
  audioPlayer.onloadeddata = () => {
    musicLoaded = true;
    updateTimeline();
    showToast('Music loaded successfully!');
  };
  audioPlayer.onerror = () => {
    showToast('Failed to load music');
  };
}

function setCanvasSize(w, h) {
  canvas.width = w;
  canvas.height = h;
  redraw();
}

function zoomIn() {
  zoomLevel = Math.min(zoomLevel + 0.1, 3);
  updateZoom();
}

function zoomOut() {
  zoomLevel = Math.max(zoomLevel - 0.1, 0.1);
  updateZoom();
}

function resetZoom() {
  zoomLevel = 1;
  updateZoom();
}

function updateZoom() {
  canvasWrapper.style.transform = `scale(${zoomLevel})`;
  document.getElementById('zoomLevel').textContent = Math.round(zoomLevel * 100) + '%';
}

function play() {
  if (isPlaying) return;
  isPlaying = true;
  
  const page = getCurrentPage();
  const fps = 30;
  
  if (musicLoaded) {
    audioPlayer.currentTime = 0;
    audioPlayer.play();
  }
  
  function animate() {
    if (!isPlaying) return;
    currentTime += 1 / fps;
    
    if (currentTime >= page.duration) {
      currentTime = 0;
      isPlaying = false;
      if (musicLoaded) audioPlayer.pause();
      return;
    }
    
    const mins = Math.floor(currentTime / 60);
    const secs = Math.floor(currentTime % 60);
    const totalMins = Math.floor(page.duration / 60);
    const totalSecs = Math.floor(page.duration % 60);
    
    document.getElementById('timeDisplay').textContent = 
      `${mins.toString().padStart(2, '0')}:${secs.toString().padStart(2, '0')} / ${totalMins.toString().padStart(2, '0')}:${totalSecs.toString().padStart(2, '0')}`;
    
    redraw();
    animationId = requestAnimationFrame(animate);
  }
  
  animate();
}

function pause() {
  isPlaying = false;
  if (animationId) cancelAnimationFrame(animationId);
  if (musicLoaded) audioPlayer.pause();
}

function reset() {
  pause();
  currentTime = 0;
  const page = getCurrentPage();
  document.getElementById('timeDisplay').textContent = `00:00 / ${page.duration.toString().padStart(2, '0')}:00`;
  if (musicLoaded) audioPlayer.currentTime = 0;
  redraw();
}

function showToast(message) {
  const toast = document.getElementById('statusToast');
  document.getElementById('statusText').textContent = message;
  toast.classList.add('show');
  setTimeout(() => toast.classList.remove('show'), 3000);
}

async function exportVideo() {
  const page = getCurrentPage();
  const duration = Number(document.getElementById('pageDuration').value) || page.duration;
  
  showToast('Rendering video...');
  
  const fps = 30;
  const totalFrames = fps * duration;

  try {
    const stream = canvas.captureStream(fps);
    let finalStream = stream;
    
    if (musicLoaded) {
      const audioCtx = new AudioContext();
      const dest = audioCtx.createMediaStreamDestination();
      const source = audioCtx.createMediaElementSource(audioPlayer);
      source.connect(dest);
      source.connect(audioCtx.destination);
      
      const audioTrack = dest.stream.getAudioTracks()[0];
      const videoTrack = stream.getVideoTracks()[0];
      finalStream = new MediaStream([videoTrack, audioTrack]);
    }
    
    const recorder = new MediaRecorder(finalStream, {
      mimeType: 'video/webm;codecs=vp9,opus',
      videoBitsPerSecond: 5000000
    });
    
    const chunks = [];
    recorder.ondataavailable = e => chunks.push(e.data);
    
    recorder.start();
    
    if (musicLoaded) {
      audioPlayer.currentTime = 0;
      audioPlayer.play();
    }

    for (let i = 0; i < totalFrames; i++) {
      currentTime = i / fps;
      redraw();
      await new Promise(resolve => setTimeout(resolve, 1000 / fps));
    }

    if (musicLoaded) audioPlayer.pause();
    recorder.stop();
    
    recorder.onstop = () => {
      const blob = new Blob(chunks, { type: 'video/webm' });
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a');
      a.href = url;
      a.download = `video-${Date.now()}.webm`;
      a.click();
      URL.revokeObjectURL(url);
      
      reset();
      showToast('Video exported successfully!');
    };
  } catch (error) {
    showToast('Export failed: ' + error.message);
  }
}

document.getElementById('bgColor').oninput = redraw;
document.getElementById('canvasSizeSelect').onchange = e => {
  const [w, h] = e.target.value.split(',').map(Number);
  setCanvasSize(w, h);
};

document.getElementById('pageDuration').oninput = e => {
  getCurrentPage().duration = Number(e.target.value);
  updatePagesUI();
  updateTimeline();
};
</script>

</body>
</html>
