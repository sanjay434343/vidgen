<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>Advanced AI Video Editor</title>
<meta name="viewport" content="width=device-width, initial-scale=1">
<style>
*{box-sizing:border-box;margin:0;padding:0}
body{
  background:#0a0a0f;
  color:#e5e7eb;
  font-family:system-ui,-apple-system,sans-serif;
  overflow:hidden;
}
.container{
  display:grid;
  grid-template-columns:280px 1fr 320px;
  height:100vh;
  gap:0;
}
.left-panel,.right-panel{
  background:#111118;
  border-right:1px solid #1e1e2e;
  overflow-y:auto;
  padding:16px;
}
.right-panel{border-right:none;border-left:1px solid #1e1e2e}
.center{
  display:flex;
  flex-direction:column;
  background:#0a0a0f;
}
.canvas-container{
  flex:1;
  display:flex;
  align-items:center;
  justify-content:center;
  padding:20px;
  position:relative;
}
canvas{
  max-width:100%;
  max-height:100%;
  background:#000;
  box-shadow:0 10px 40px rgba(0,0,0,0.5);
}
.timeline{
  height:120px;
  background:#16161d;
  border-top:1px solid #1e1e2e;
  padding:10px;
  overflow-x:auto;
}
h3{
  color:#fff;
  margin-bottom:12px;
  font-size:14px;
  text-transform:uppercase;
  letter-spacing:0.5px;
}
.section{
  margin-bottom:20px;
  padding-bottom:16px;
  border-bottom:1px solid #1e1e2e;
}
.section:last-child{border-bottom:none}
label{
  display:block;
  font-size:12px;
  color:#9ca3af;
  margin:8px 0 4px;
  font-weight:500;
}
input[type="text"],input[type="number"],select,textarea{
  width:100%;
  padding:8px 10px;
  background:#1a1a24;
  color:#e5e7eb;
  border:1px solid #2a2a3a;
  border-radius:6px;
  font-size:13px;
  transition:border 0.2s;
}
input:focus,select:focus,textarea:focus{
  outline:none;
  border-color:#4f46e5;
}
textarea{
  resize:vertical;
  min-height:60px;
  font-family:inherit;
}
input[type="range"]{
  width:100%;
  height:6px;
  background:#2a2a3a;
  border-radius:3px;
  outline:none;
  -webkit-appearance:none;
}
input[type="range"]::-webkit-slider-thumb{
  -webkit-appearance:none;
  width:16px;
  height:16px;
  background:#4f46e5;
  border-radius:50%;
  cursor:pointer;
}
input[type="range"]::-moz-range-thumb{
  width:16px;
  height:16px;
  background:#4f46e5;
  border-radius:50%;
  cursor:pointer;
  border:none;
}
input[type="color"]{
  width:100%;
  height:36px;
  padding:2px;
  border:1px solid #2a2a3a;
  border-radius:6px;
  background:#1a1a24;
  cursor:pointer;
}
input[type="file"]{
  font-size:12px;
  padding:6px;
  cursor:pointer;
}
button{
  width:100%;
  padding:10px 16px;
  font-weight:600;
  font-size:13px;
  border-radius:8px;
  cursor:pointer;
  border:none;
  transition:all 0.2s;
  margin-top:8px;
}
.primary{
  background:linear-gradient(135deg,#4f46e5,#7c3aed);
  color:#fff;
}
.primary:hover{
  transform:translateY(-1px);
  box-shadow:0 4px 12px rgba(79,70,229,0.4);
}
.secondary{
  background:#1a1a24;
  color:#e5e7eb;
  border:1px solid #2a2a3a;
}
.secondary:hover{background:#22222d}
.danger{background:#dc2626;color:#fff}
.danger:hover{background:#b91c1c}
.layer-item{
  background:#1a1a24;
  padding:10px;
  margin:6px 0;
  border-radius:6px;
  border:2px solid transparent;
  cursor:pointer;
  display:flex;
  justify-content:space-between;
  align-items:center;
  transition:all 0.2s;
}
.layer-item:hover{background:#22222d}
.layer-item.active{border-color:#4f46e5;background:#1e1e3a}
.layer-badge{
  font-size:10px;
  padding:2px 6px;
  background:#2a2a3a;
  border-radius:4px;
  text-transform:uppercase;
}
.value-display{
  display:inline-block;
  float:right;
  font-size:11px;
  color:#6b7280;
  font-weight:600;
}
.grid-2{
  display:grid;
  grid-template-columns:1fr 1fr;
  gap:8px;
}
.preset-btn{
  padding:8px;
  background:#1a1a24;
  border:1px solid #2a2a3a;
  border-radius:6px;
  color:#e5e7eb;
  cursor:pointer;
  font-size:12px;
  text-align:center;
  transition:all 0.2s;
}
.preset-btn:hover{background:#22222d;border-color:#4f46e5}
.export-options{display:grid;gap:8px}
.status{
  position:fixed;
  bottom:20px;
  right:340px;
  background:#1a1a24;
  padding:12px 20px;
  border-radius:8px;
  border:1px solid #2a2a3a;
  display:none;
  box-shadow:0 4px 12px rgba(0,0,0,0.3);
}
.status.show{display:block}
.loader{
  display:inline-block;
  width:14px;
  height:14px;
  border:2px solid #4f46e5;
  border-top-color:transparent;
  border-radius:50%;
  animation:spin 0.8s linear infinite;
  margin-right:8px;
}
@keyframes spin{to{transform:rotate(360deg)}}
</style>
</head>
<body>

<div class="container">
  <!-- LEFT PANEL: LAYERS -->
  <div class="left-panel">
    <h3>üé¨ Layers</h3>
    <button class="secondary" onclick="addLayer('text')">+ Add Text</button>
    <button class="secondary" onclick="addLayer('image')">+ Add Image</button>
    <div id="layers" style="margin-top:12px"></div>
  </div>

  <!-- CENTER: CANVAS -->
  <div class="center">
    <div class="canvas-container">
      <canvas id="canvas"></canvas>
    </div>
    <div class="timeline">
      <div style="color:#9ca3af;font-size:12px;margin-bottom:8px">Timeline (0-10s)</div>
      <div style="display:flex;gap:8px">
        <button class="secondary" style="width:auto;padding:8px 16px" onclick="play()">‚ñ∂ Play</button>
        <button class="secondary" style="width:auto;padding:8px 16px" onclick="pause()">‚è∏ Pause</button>
        <button class="secondary" style="width:auto;padding:8px 16px" onclick="reset()">‚èÆ Reset</button>
        <div style="flex:1"></div>
        <span id="timeDisplay" style="color:#9ca3af;font-size:13px;padding:8px">0.0s</span>
      </div>
    </div>
  </div>

  <!-- RIGHT PANEL: PROPERTIES -->
  <div class="right-panel">
    <h3>‚öôÔ∏è Properties</h3>
    
    <div class="section">
      <label>Canvas Size</label>
      <div class="grid-2">
        <div class="preset-btn" onclick="setCanvasSize(1080,1920)">9:16<br><small>1080√ó1920</small></div>
        <div class="preset-btn" onclick="setCanvasSize(1920,1080)">16:9<br><small>1920√ó1080</small></div>
        <div class="preset-btn" onclick="setCanvasSize(1080,1080)">1:1<br><small>1080√ó1080</small></div>
        <div class="preset-btn" onclick="setCanvasSize(720,1280)">9:16 HD<br><small>720√ó1280</small></div>
      </div>
      <label style="margin-top:8px">Background Color</label>
      <input type="color" id="bgColor" value="#000000">
    </div>

    <div id="propertyPanel" style="display:none">
      <!-- IMAGE PROPERTIES -->
      <div id="imageProps" style="display:none">
        <div class="section">
          <label>Upload Image</label>
          <input type="file" id="imgUpload" accept="image/*">
        </div>
        <div class="section">
          <label>Position X <span class="value-display" id="imgXVal">0</span></label>
          <input type="range" id="imgX" min="-1000" max="1000" value="0">
          <label>Position Y <span class="value-display" id="imgYVal">0</span></label>
          <input type="range" id="imgY" min="-1000" max="1000" value="0">
        </div>
        <div class="section">
          <label>Scale <span class="value-display" id="imgScaleVal">1.0</span></label>
          <input type="range" id="imgScale" min="0.1" max="3" step="0.01" value="1">
          <label>Rotation <span class="value-display" id="imgRotateVal">0¬∞</span></label>
          <input type="range" id="imgRotate" min="-180" max="180" value="0">
          <label>Opacity <span class="value-display" id="imgOpacityVal">100%</span></label>
          <input type="range" id="imgOpacity" min="0" max="1" step="0.01" value="1">
        </div>
        <div class="section">
          <label>Fit Mode</label>
          <select id="imgFit">
            <option value="cover">Cover</option>
            <option value="contain">Contain</option>
            <option value="fill">Fill</option>
          </select>
        </div>
        <button class="danger" onclick="deleteLayer()">üóë Delete Layer</button>
      </div>

      <!-- TEXT PROPERTIES -->
      <div id="textProps" style="display:none">
        <div class="section">
          <label>Text Content</label>
          <textarea id="textContent" placeholder="Enter your text..."></textarea>
        </div>
        <div class="section">
          <label>Position X <span class="value-display" id="textXVal">0</span></label>
          <input type="range" id="textX" min="-1000" max="1000" value="0">
          <label>Position Y <span class="value-display" id="textYVal">-200</span></label>
          <input type="range" id="textY" min="-1000" max="1000" value="-200">
        </div>
        <div class="section">
          <label>Font Family</label>
          <select id="fontFamily">
            <option value="Arial">Arial</option>
            <option value="Helvetica">Helvetica</option>
            <option value="Times New Roman">Times New Roman</option>
            <option value="Georgia">Georgia</option>
            <option value="Courier New">Courier New</option>
            <option value="Verdana">Verdana</option>
            <option value="Impact">Impact</option>
            <option value="Comic Sans MS">Comic Sans MS</option>
            <option value="Trebuchet MS">Trebuchet MS</option>
            <option value="system-ui">System UI</option>
          </select>
          <label>Font Size <span class="value-display" id="fontSizeVal">48px</span></label>
          <input type="range" id="fontSize" min="12" max="200" value="48">
          <label>Font Weight</label>
          <select id="fontWeight">
            <option value="300">Light (300)</option>
            <option value="400">Normal (400)</option>
            <option value="600">Semi-Bold (600)</option>
            <option value="700">Bold (700)</option>
            <option value="900">Black (900)</option>
          </select>
        </div>
        <div class="section">
          <label>Text Color</label>
          <input type="color" id="textColor" value="#ffffff">
          <label>Background Color</label>
          <input type="color" id="textBgColor" value="#00000000">
          <label>Background Opacity <span class="value-display" id="textBgOpacityVal">0%</span></label>
          <input type="range" id="textBgOpacity" min="0" max="1" step="0.01" value="0">
        </div>
        <div class="section">
          <label>Text Align</label>
          <select id="textAlign">
            <option value="left">Left</option>
            <option value="center">Center</option>
            <option value="right">Right</option>
          </select>
          <label>Rotation <span class="value-display" id="textRotateVal">0¬∞</span></label>
          <input type="range" id="textRotate" min="-180" max="180" value="0">
          <label>Letter Spacing <span class="value-display" id="letterSpacingVal">0px</span></label>
          <input type="range" id="letterSpacing" min="-10" max="30" value="0">
          <label>Line Height <span class="value-display" id="lineHeightVal">1.2</span></label>
          <input type="range" id="lineHeight" min="0.8" max="2.5" step="0.1" value="1.2">
        </div>
        <div class="section">
          <label>Stroke Width <span class="value-display" id="strokeWidthVal">0px</span></label>
          <input type="range" id="strokeWidth" min="0" max="10" value="0">
          <label>Stroke Color</label>
          <input type="color" id="strokeColor" value="#000000">
        </div>
        <div class="section">
          <label>Shadow Blur <span class="value-display" id="shadowBlurVal">0px</span></label>
          <input type="range" id="shadowBlur" min="0" max="30" value="0">
          <label>Shadow X <span class="value-display" id="shadowXVal">0px</span></label>
          <input type="range" id="shadowX" min="-20" max="20" value="0">
          <label>Shadow Y <span class="value-display" id="shadowYVal">0px</span></label>
          <input type="range" id="shadowY" min="-20" max="20" value="0">
          <label>Shadow Color</label>
          <input type="color" id="shadowColor" value="#000000">
        </div>
        <button class="danger" onclick="deleteLayer()">üóë Delete Layer</button>
      </div>
    </div>

    <div class="section">
      <h3 style="margin-top:20px">üì§ Export</h3>
      <label>Duration (seconds)</label>
      <input type="number" id="duration" value="5" min="1" max="30">
      <label>Frame Rate</label>
      <select id="fps">
        <option value="24">24 FPS</option>
        <option value="30" selected>30 FPS</option>
        <option value="60">60 FPS</option>
      </select>
      <div class="export-options">
        <button class="primary" onclick="exportVideo('webm')">Export as WebM</button>
        <button class="primary" onclick="exportVideo('mp4')">Export as MP4</button>
      </div>
    </div>
  </div>
</div>

<div class="status" id="status"></div>

<script>
const canvas = document.getElementById("canvas");
const ctx = canvas.getContext("2d");

canvas.width = 1080;
canvas.height = 1920;

let layers = [];
let activeLayerId = null;
let isPlaying = false;
let currentTime = 0;
let animationId = null;

// Initialize
redraw();
updateLayersList();

function redraw(){
  const bgColor = document.getElementById("bgColor").value;
  ctx.fillStyle = bgColor;
  ctx.fillRect(0,0,canvas.width,canvas.height);

  layers.forEach(layer => {
    if(layer.type === "image" && layer.image){
      drawImage(layer);
    } else if(layer.type === "text"){
      drawText(layer);
    }
  });
}

function drawImage(layer){
  ctx.save();
  ctx.globalAlpha = layer.opacity;
  ctx.translate(canvas.width/2+layer.x, canvas.height/2+layer.y);
  ctx.rotate(layer.rotate*Math.PI/180);
  ctx.scale(layer.scale, layer.scale);

  const ratio = layer.image.width/layer.image.height;
  let w,h;
  
  if(layer.fit==="cover"){
    if(canvas.width/canvas.height > ratio){
      w = canvas.width; h = w/ratio;
    } else {
      h = canvas.height; w = h*ratio;
    }
  } else if(layer.fit==="contain"){
    if(canvas.width/canvas.height < ratio){
      w = canvas.width; h = w/ratio;
    } else {
      h = canvas.height; w = h*ratio;
    }
  } else {
    w = canvas.width;
    h = canvas.height;
  }

  ctx.drawImage(layer.image,-w/2,-h/2,w,h);
  ctx.restore();
}

function drawText(layer){
  ctx.save();
  ctx.translate(canvas.width/2+layer.x, canvas.height/2+layer.y);
  ctx.rotate(layer.rotate*Math.PI/180);

  ctx.font = `${layer.fontWeight} ${layer.fontSize}px ${layer.fontFamily}`;
  ctx.textAlign = layer.textAlign;
  ctx.textBaseline = "middle";

  const lines = layer.text.split('\n');
  const lineHeightPx = layer.fontSize * layer.lineHeight;

  lines.forEach((line, i) => {
    const yOffset = (i - (lines.length-1)/2) * lineHeightPx;
    
    // Background
    if(layer.bgOpacity > 0){
      const metrics = ctx.measureText(line);
      const padding = 10;
      ctx.fillStyle = layer.bgColor + Math.round(layer.bgOpacity*255).toString(16).padStart(2,'0');
      ctx.fillRect(
        -metrics.width/2 - padding,
        yOffset - layer.fontSize/2 - padding,
        metrics.width + padding*2,
        layer.fontSize + padding*2
      );
    }

    // Shadow
    if(layer.shadowBlur > 0){
      ctx.shadowBlur = layer.shadowBlur;
      ctx.shadowOffsetX = layer.shadowX;
      ctx.shadowOffsetY = layer.shadowY;
      ctx.shadowColor = layer.shadowColor;
    }

    // Stroke
    if(layer.strokeWidth > 0){
      ctx.strokeStyle = layer.strokeColor;
      ctx.lineWidth = layer.strokeWidth;
      ctx.strokeText(line, 0, yOffset);
    }

    // Text
    ctx.fillStyle = layer.textColor;
    ctx.fillText(line, 0, yOffset);
    
    ctx.shadowBlur = 0;
  });

  ctx.restore();
}

function addLayer(type){
  const id = Date.now();
  const layer = {
    id,
    type,
    name: `${type.charAt(0).toUpperCase() + type.slice(1)} ${layers.length + 1}`
  };

  if(type === "image"){
    layer.x = 0;
    layer.y = 0;
    layer.scale = 1;
    layer.rotate = 0;
    layer.opacity = 1;
    layer.fit = "cover";
    layer.image = null;
  } else if(type === "text"){
    layer.text = "Your Text Here";
    layer.x = 0;
    layer.y = -200;
    layer.fontSize = 48;
    layer.fontFamily = "Arial";
    layer.fontWeight = "700";
    layer.textColor = "#ffffff";
    layer.bgColor = "#000000";
    layer.bgOpacity = 0;
    layer.textAlign = "center";
    layer.rotate = 0;
    layer.letterSpacing = 0;
    layer.lineHeight = 1.2;
    layer.strokeWidth = 0;
    layer.strokeColor = "#000000";
    layer.shadowBlur = 0;
    layer.shadowX = 0;
    layer.shadowY = 0;
    layer.shadowColor = "#000000";
  }

  layers.push(layer);
  selectLayer(id);
  updateLayersList();
  redraw();
}

function selectLayer(id){
  activeLayerId = id;
  updateLayersList();
  updatePropertyPanel();
}

function deleteLayer(){
  if(!activeLayerId) return;
  layers = layers.filter(l => l.id !== activeLayerId);
  activeLayerId = null;
  updateLayersList();
  updatePropertyPanel();
  redraw();
}

function updateLayersList(){
  const container = document.getElementById("layers");
  container.innerHTML = layers.map(layer => `
    <div class="layer-item ${layer.id === activeLayerId ? 'active' : ''}" 
         onclick="selectLayer(${layer.id})">
      <span>${layer.name}</span>
      <span class="layer-badge">${layer.type}</span>
    </div>
  `).join('');
}

function updatePropertyPanel(){
  const panel = document.getElementById("propertyPanel");
  const imageProps = document.getElementById("imageProps");
  const textProps = document.getElementById("textProps");

  if(!activeLayerId){
    panel.style.display = "none";
    return;
  }

  panel.style.display = "block";
  const layer = layers.find(l => l.id === activeLayerId);

  if(layer.type === "image"){
    imageProps.style.display = "block";
    textProps.style.display = "none";
    loadImageProps(layer);
  } else if(layer.type === "text"){
    imageProps.style.display = "none";
    textProps.style.display = "block";
    loadTextProps(layer);
  }
}

function loadImageProps(layer){
  const bindings = [
    ['imgX', 'x', v => v + 'px'],
    ['imgY', 'y', v => v + 'px'],
    ['imgScale', 'scale', v => v.toFixed(2)],
    ['imgRotate', 'rotate', v => v + '¬∞'],
    ['imgOpacity', 'opacity', v => Math.round(v*100) + '%']
  ];

  bindings.forEach(([id, prop, format]) => {
    const el = document.getElementById(id);
    el.value = layer[prop];
    document.getElementById(id+'Val').textContent = format(layer[prop]);
    el.oninput = e => {
      layer[prop] = Number(e.target.value);
      document.getElementById(id+'Val').textContent = format(layer[prop]);
      redraw();
    };
  });

  document.getElementById('imgFit').value = layer.fit;
  document.getElementById('imgFit').onchange = e => {
    layer.fit = e.target.value;
    redraw();
  };

  document.getElementById('imgUpload').onchange = e => {
    const file = e.target.files[0];
    if(!file) return;
    const reader = new FileReader();
    reader.onload = () => {
      const img = new Image();
      img.onload = () => {
        layer.image = img;
        redraw();
      };
      img.src = reader.result;
    };
    reader.readAsDataURL(file);
  };
}

function loadTextProps(layer){
  const textBindings = [
    ['textX', 'x', v => v + 'px'],
    ['textY', 'y', v => v + 'px'],
    ['fontSize', 'fontSize', v => v + 'px'],
    ['textRotate', 'rotate', v => v + '¬∞'],
    ['letterSpacing', 'letterSpacing', v => v + 'px'],
    ['lineHeight', 'lineHeight', v => v.toFixed(1)],
    ['strokeWidth', 'strokeWidth', v => v + 'px'],
    ['shadowBlur', 'shadowBlur', v => v + 'px'],
    ['shadowX', 'shadowX', v => v + 'px'],
    ['shadowY', 'shadowY', v => v + 'px'],
    ['textBgOpacity', 'bgOpacity', v => Math.round(v*100) + '%']
  ];

  textBindings.forEach(([id, prop, format]) => {
    const el = document.getElementById(id);
    el.value = layer[prop];
    if(document.getElementById(id+'Val')){
      document.getElementById(id+'Val').textContent = format(layer[prop]);
    }
    el.oninput = e => {
      layer[prop] = Number(e.target.value);
      if(document.getElementById(id+'Val')){
        document.getElementById(id+'Val').textContent = format(layer[prop]);
      }
      redraw();
    };
  });

  const simpleBindings = [
    ['textContent', 'text'],
    ['fontFamily', 'fontFamily'],
    ['fontWeight', 'fontWeight'],
    ['textColor', 'textColor'],
    ['textBgColor', 'bgColor'],
    ['textAlign', 'textAlign'],
    ['strokeColor', 'strokeColor'],
    ['shadowColor', 'shadowColor']
  ];

  simpleBindings.forEach(([id, prop]) => {
    const el = document.getElementById(id);
    el.value = layer[prop];
    el.oninput = e => {
      layer[prop] = e.target.value;
      redraw();
    };
  });
}

function setCanvasSize(w,h){
  canvas.width = w;
  canvas.height = h;
  redraw();
}

document.getElementById('bgColor').oninput = redraw;

function play(){
  if(isPlaying) return;
  isPlaying = true;
  const fps = Number(document.getElementById('fps').value);
  const duration = Number(document.getElementById('duration').value);
  
  function animate(){
    if(!isPlaying) return;
    currentTime += 1/fps;
    if(currentTime >= duration){
      currentTime = 0;
      isPlaying = false;
      return;
    }
    document.getElementById('timeDisplay').textContent = currentTime.toFixed(1) + 's';
    redraw();
    animationId = requestAnimationFrame(animate);
  }
  animate();
}

function pause(){
  isPlaying = false;
  if(animationId) cancelAnimationFrame(animationId);
}

function reset(){
  pause();
  currentTime = 0;
  document.getElementById('timeDisplay').textContent = '0.0s';
  redraw();
}

function showStatus(msg){
  const status = document.getElementById('status');
  status.innerHTML = `<span class="loader"></span>${msg}`;
  status.classList.add('show');
}

function hideStatus(){
  document.getElementById('status').classList.remove('show');
}

async function exportVideo(format){
  showStatus(`Rendering ${format.toUpperCase()} video...`);
  
  const fps = Number(document.getElementById('fps').value);
  const duration = Number(document.getElementById('duration').value);
  const totalFrames = fps * duration;

  if(format === 'mp4'){
    alert('MP4 export requires server-side processing. This will export as WebM instead.\n\nTo get MP4, you can:\n1. Use online converters (CloudConvert, FreeConvert)\n2. Use FFmpeg locally\n3. Use video editing software');
    format = 'webm';
  }

  try {
    const stream = canvas.captureStream(fps);
    const recorder = new MediaRecorder(stream, {
      mimeType: 'video/webm;codecs=vp9',
      videoBitsPerSecond: 5000000
    });
    
    const chunks = [];
    recorder.ondataavailable = e => chunks.push(e.data);
    
    recorder.start();

    for(let i = 0; i < totalFrames; i++){
      currentTime = i / fps;
      document.getElementById('timeDisplay').textContent = currentTime.toFixed(1) + 's';
      redraw();
      await new Promise(resolve => setTimeout(resolve, 1000/fps));
    }

    recorder.stop();
    
    recorder.onstop = () => {
      const blob = new Blob(chunks, {type: 'video/webm'});
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a');
      a.href = url;
      a.download = `video-${Date.now()}.${format}`;
      a.click();
      URL.revokeObjectURL(url);
      
      reset();
      hideStatus();
      alert('Video exported successfully!');
