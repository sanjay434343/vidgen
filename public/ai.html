<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>Advanced AI Video Editor</title>
<meta name="viewport" content="width=device-width, initial-scale=1">
<style>
*{box-sizing:border-box;margin:0;padding:0}
body{
  background:#0a0a0f;
  color:#e5e7eb;
  font-family:system-ui,-apple-system,sans-serif;
  overflow:hidden;
}
.container{
  display:grid;
  grid-template-columns:280px 1fr 340px;
  height:100vh;
  gap:0;
}
.left-panel,.right-panel{
  background:#111118;
  border-right:1px solid #1e1e2e;
  overflow-y:auto;
  padding:16px;
}
.right-panel{
  border-right:none;
  border-left:1px solid #1e1e2e;
  max-height:100vh;
  overflow-y:scroll;
}
.right-panel::-webkit-scrollbar{width:8px}
.right-panel::-webkit-scrollbar-track{background:#1a1a24}
.right-panel::-webkit-scrollbar-thumb{background:#4f46e5;border-radius:4px}
.center{
  display:flex;
  flex-direction:column;
  background:#0a0a0f;
}
.canvas-container{
  flex:1;
  display:flex;
  align-items:center;
  justify-content:center;
  padding:20px;
  position:relative;
  cursor:move;
}
.canvas-container.dragging{cursor:grabbing}
canvas{
  max-width:100%;
  max-height:100%;
  background:#000;
  box-shadow:0 10px 40px rgba(0,0,0,0.5);
  cursor:grab;
}
canvas:active{cursor:grabbing}
.timeline{
  height:140px;
  background:#16161d;
  border-top:1px solid #1e1e2e;
  padding:10px;
  overflow-x:auto;
}
h3{
  color:#fff;
  margin-bottom:12px;
  font-size:14px;
  text-transform:uppercase;
  letter-spacing:0.5px;
}
.section{
  margin-bottom:20px;
  padding-bottom:16px;
  border-bottom:1px solid #1e1e2e;
}
.section:last-child{border-bottom:none}
label{
  display:block;
  font-size:12px;
  color:#9ca3af;
  margin:8px 0 4px;
  font-weight:500;
}
input[type="text"],input[type="url"],input[type="number"],select,textarea{
  width:100%;
  padding:8px 10px;
  background:#1a1a24;
  color:#e5e7eb;
  border:1px solid #2a2a3a;
  border-radius:6px;
  font-size:13px;
  transition:border 0.2s;
}
input:focus,select:focus,textarea:focus{
  outline:none;
  border-color:#4f46e5;
}
textarea{
  resize:vertical;
  min-height:60px;
  font-family:inherit;
}
input[type="range"]{
  width:100%;
  height:6px;
  background:#2a2a3a;
  border-radius:3px;
  outline:none;
  -webkit-appearance:none;
}
input[type="range"]::-webkit-slider-thumb{
  -webkit-appearance:none;
  width:16px;
  height:16px;
  background:#4f46e5;
  border-radius:50%;
  cursor:pointer;
}
input[type="range"]::-moz-range-thumb{
  width:16px;
  height:16px;
  background:#4f46e5;
  border-radius:50%;
  cursor:pointer;
  border:none;
}
input[type="color"]{
  width:100%;
  height:36px;
  padding:2px;
  border:1px solid #2a2a3a;
  border-radius:6px;
  background:#1a1a24;
  cursor:pointer;
}
input[type="file"]{
  font-size:12px;
  padding:6px;
  cursor:pointer;
}
button{
  width:100%;
  padding:10px 16px;
  font-weight:600;
  font-size:13px;
  border-radius:8px;
  cursor:pointer;
  border:none;
  transition:all 0.2s;
  margin-top:8px;
}
.primary{
  background:linear-gradient(135deg,#4f46e5,#7c3aed);
  color:#fff;
}
.primary:hover{
  transform:translateY(-1px);
  box-shadow:0 4px 12px rgba(79,70,229,0.4);
}
.secondary{
  background:#1a1a24;
  color:#e5e7eb;
  border:1px solid #2a2a3a;
}
.secondary:hover{background:#22222d}
.danger{background:#dc2626;color:#fff}
.danger:hover{background:#b91c1c}
.layer-item{
  background:#1a1a24;
  padding:10px;
  margin:6px 0;
  border-radius:6px;
  border:2px solid transparent;
  cursor:pointer;
  display:flex;
  justify-content:space-between;
  align-items:center;
  transition:all 0.2s;
}
.layer-item:hover{background:#22222d}
.layer-item.active{border-color:#4f46e5;background:#1e1e3a}
.layer-badge{
  font-size:10px;
  padding:2px 6px;
  background:#2a2a3a;
  border-radius:4px;
  text-transform:uppercase;
}
.value-display{
  display:inline-block;
  float:right;
  font-size:11px;
  color:#6b7280;
  font-weight:600;
}
.grid-2{
  display:grid;
  grid-template-columns:1fr 1fr;
  gap:8px;
}
.preset-btn{
  padding:8px;
  background:#1a1a24;
  border:1px solid #2a2a3a;
  border-radius:6px;
  color:#e5e7eb;
  cursor:pointer;
  font-size:12px;
  text-align:center;
  transition:all 0.2s;
}
.preset-btn:hover{background:#22222d;border-color:#4f46e5}
.export-options{display:grid;gap:8px}
.status{
  position:fixed;
  bottom:20px;
  right:360px;
  background:#1a1a24;
  padding:12px 20px;
  border-radius:8px;
  border:1px solid #2a2a3a;
  display:none;
  box-shadow:0 4px 12px rgba(0,0,0,0.3);
  z-index:1000;
}
.status.show{display:block}
.loader{
  display:inline-block;
  width:14px;
  height:14px;
  border:2px solid #4f46e5;
  border-top-color:transparent;
  border-radius:50%;
  animation:spin 0.8s linear infinite;
  margin-right:8px;
}
@keyframes spin{to{transform:rotate(360deg)}}
.help-text{
  font-size:11px;
  color:#6b7280;
  margin-top:4px;
  font-style:italic;
}
.music-controls{
  display:flex;
  gap:8px;
  margin-top:8px;
}
.music-controls button{
  width:auto;
  padding:8px 12px;
  font-size:12px;
}
</style>
</head>
<body>

<div class="container">
  <!-- LEFT PANEL: LAYERS -->
  <div class="left-panel">
    <h3>üé¨ Layers</h3>
    <button class="primary" onclick="addLayer('group')">+ Add Group (Text on Image)</button>
    <div id="layers" style="margin-top:12px"></div>
  </div>

  <!-- CENTER: CANVAS -->
  <div class="center">
    <div class="canvas-container" id="canvasContainer">
      <canvas id="canvas"></canvas>
    </div>
    <div class="timeline">
      <div style="color:#9ca3af;font-size:12px;margin-bottom:8px">Timeline ‚Ä¢ Drag on canvas to move elements</div>
      <div style="display:flex;gap:8px;margin-bottom:8px">
        <button class="secondary" style="width:auto;padding:8px 16px" onclick="play()">‚ñ∂ Play</button>
        <button class="secondary" style="width:auto;padding:8px 16px" onclick="pause()">‚è∏ Pause</button>
        <button class="secondary" style="width:auto;padding:8px 16px" onclick="reset()">‚èÆ Reset</button>
        <div style="flex:1"></div>
        <span id="timeDisplay" style="color:#9ca3af;font-size:13px;padding:8px">0.0s</span>
      </div>
      <div id="musicControls" style="display:none">
        <audio id="audioPlayer" style="width:100%;height:32px"></audio>
      </div>
    </div>
  </div>

  <!-- RIGHT PANEL: PROPERTIES -->
  <div class="right-panel">
    <h3>‚öôÔ∏è Canvas Settings</h3>
    
    <div class="section">
      <label>Canvas Size</label>
      <div class="grid-2">
        <div class="preset-btn" onclick="setCanvasSize(1080,1920)">9:16<br><small>1080√ó1920</small></div>
        <div class="preset-btn" onclick="setCanvasSize(1920,1080)">16:9<br><small>1920√ó1080</small></div>
        <div class="preset-btn" onclick="setCanvasSize(1080,1080)">1:1<br><small>1080√ó1080</small></div>
        <div class="preset-btn" onclick="setCanvasSize(720,1280)">9:16 HD<br><small>720√ó1280</small></div>
      </div>
      <label style="margin-top:8px">Background Color</label>
      <input type="color" id="bgColor" value="#000000">
    </div>

    <div class="section">
      <h3>üéµ Background Music</h3>
      <label>Music URL (MP3/Audio)</label>
      <input type="url" id="musicUrl" placeholder="https://example.com/music.mp3">
      <p class="help-text">Paste direct link to audio file</p>
      <div class="music-controls">
        <button class="secondary" onclick="loadMusic()">Load Music</button>
        <button class="secondary" onclick="clearMusic()">Clear</button>
      </div>
    </div>

    <div id="propertyPanel" style="display:none">
      <!-- GROUP PROPERTIES -->
      <div id="groupProps">
        <div class="section">
          <h3>üì∏ Background Image</h3>
          <label>Upload Background Image</label>
          <input type="file" id="groupImgUpload" accept="image/*">
          <p class="help-text">Or drag image on canvas to reposition</p>
          
          <label>Image Position X <span class="value-display" id="imgPosXVal">0</span></label>
          <input type="range" id="imgPosX" min="-500" max="500" value="0">
          <label>Image Position Y <span class="value-display" id="imgPosYVal">0</span></label>
          <input type="range" id="imgPosY" min="-500" max="500" value="0">
          <label>Image Scale <span class="value-display" id="imgScaleVal">1.0</span></label>
          <input type="range" id="imgScale" min="0.5" max="3" step="0.01" value="1">
          
          <label>Image Opacity <span class="value-display" id="imgOpacityVal">100%</span></label>
          <input type="range" id="imgOpacity" min="0" max="1" step="0.01" value="1">
          <label>Image Blur <span class="value-display" id="imgBlurVal">0px</span></label>
          <input type="range" id="imgBlur" min="0" max="30" value="0">
          <label>Image Fit</label>
          <select id="imgFit">
            <option value="cover">Cover</option>
            <option value="contain">Contain</option>
            <option value="fill">Fill</option>
          </select>
        </div>

        <div class="section">
          <h3>üí¨ Text Content</h3>
          <label>Text</label>
          <textarea id="groupText" placeholder="Enter your text...">YOUR TEXT HERE</textarea>
        </div>

        <div class="section">
          <h3>üé® Text Style</h3>
          <label>Font Family</label>
          <select id="groupFontFamily">
            <option value="Arial">Arial</option>
            <option value="Helvetica">Helvetica</option>
            <option value="Impact">Impact</option>
            <option value="Georgia">Georgia</option>
            <option value="Verdana">Verdana</option>
            <option value="'Courier New'">Courier New</option>
            <option value="'Times New Roman'">Times New Roman</option>
            <option value="system-ui">System UI</option>
          </select>
          <label>Font Size <span class="value-display" id="groupFontSizeVal">64px</span></label>
          <input type="range" id="groupFontSize" min="12" max="200" value="64">
          <label>Font Weight</label>
          <select id="groupFontWeight">
            <option value="300">Light</option>
            <option value="400">Normal</option>
            <option value="600">Semi-Bold</option>
            <option value="700">Bold</option>
            <option value="900" selected>Black</option>
          </select>
          <label>Text Color</label>
          <input type="color" id="groupTextColor" value="#ffffff">
        </div>

        <div class="section">
          <h3>üìç Text Position</h3>
          <label>Position X <span class="value-display" id="textXVal">0</span></label>
          <input type="range" id="textX" min="-1000" max="1000" value="0">
          <label>Position Y <span class="value-display" id="textYVal">0</span></label>
          <input type="range" id="textY" min="-1000" max="1000" value="0">
          <label>Text Align</label>
          <select id="textAlign">
            <option value="left">Left</option>
            <option value="center" selected>Center</option>
            <option value="right">Right</option>
          </select>
          <label>Line Height <span class="value-display" id="lineHeightVal">1.2</span></label>
          <input type="range" id="lineHeight" min="0.8" max="2.5" step="0.1" value="1.2">
        </div>

        <div class="section">
          <h3>‚ú® Text Effects</h3>
          <label>Text Background Color</label>
          <input type="color" id="textBgColor" value="#000000">
          <label>Text Background Opacity <span class="value-display" id="textBgOpacityVal">0%</span></label>
          <input type="range" id="textBgOpacity" min="0" max="1" step="0.01" value="0">
          <label>Background Padding <span class="value-display" id="textBgPaddingVal">20px</span></label>
          <input type="range" id="textBgPadding" min="0" max="100" value="20">
          
          <label>Stroke Width <span class="value-display" id="strokeWidthVal">0px</span></label>
          <input type="range" id="strokeWidth" min="0" max="20" value="0">
          <label>Stroke Color</label>
          <input type="color" id="strokeColor" value="#000000">
          
          <label>Shadow Blur <span class="value-display" id="shadowBlurVal">10px</span></label>
          <input type="range" id="shadowBlur" min="0" max="50" value="10">
          <label>Shadow X <span class="value-display" id="shadowXVal">0px</span></label>
          <input type="range" id="shadowX" min="-30" max="30" value="0">
          <label>Shadow Y <span class="value-display" id="shadowYVal">0px</span></label>
          <input type="range" id="shadowY" min="-30" max="30" value="0">
          <label>Shadow Color</label>
          <input type="color" id="shadowColor" value="#000000">
        </div>

        <div class="section">
          <h3>üéØ Group Transform</h3>
          <label>Position X <span class="value-display" id="groupXVal">0</span></label>
          <input type="range" id="groupX" min="-1000" max="1000" value="0">
          <label>Position Y <span class="value-display" id="groupYVal">0</span></label>
          <input type="range" id="groupY" min="-1000" max="1000" value="0">
          <label>Scale <span class="value-display" id="groupScaleVal">1.0</span></label>
          <input type="range" id="groupScale" min="0.1" max="3" step="0.01" value="1">
          <label>Rotation <span class="value-display" id="groupRotateVal">0¬∞</span></label>
          <input type="range" id="groupRotate" min="-180" max="180" value="0">
          <label>Group Opacity <span class="value-display" id="groupOpacityVal">100%</span></label>
          <input type="range" id="groupOpacity" min="0" max="1" step="0.01" value="1">
        </div>

        <button class="danger" onclick="deleteLayer()">üóë Delete Layer</button>
      </div>
    </div>

    <div class="section">
      <h3 style="margin-top:20px">üì§ Export</h3>
      <label>Duration (seconds)</label>
      <input type="number" id="duration" value="5" min="1" max="30">
      <label>Frame Rate</label>
      <select id="fps">
        <option value="24">24 FPS</option>
        <option value="30" selected>30 FPS</option>
        <option value="60">60 FPS</option>
      </select>
      <div class="export-options">
        <button class="primary" onclick="exportVideo('webm')">üìπ Export Video (WebM)</button>
      </div>
      <p class="help-text">Video will include audio if music is loaded</p>
    </div>
  </div>
</div>

<div class="status" id="status"></div>

<script>
const canvas = document.getElementById("canvas");
const ctx = canvas.getContext("2d");
const canvasContainer = document.getElementById("canvasContainer");
const audioPlayer = document.getElementById("audioPlayer");
const musicControls = document.getElementById("musicControls");

canvas.width = 1080;
canvas.height = 1920;

let layers = [];
let activeLayerId = null;
let isPlaying = false;
let currentTime = 0;
let animationId = null;
let isDragging = false;
let dragStartX = 0;
let dragStartY = 0;
let dragType = null;
let musicLoaded = false;

redraw();
updateLayersList();

// Canvas drag functionality
canvas.addEventListener('mousedown', e => {
  if(!activeLayerId) return;
  const layer = layers.find(l => l.id === activeLayerId);
  if(!layer) return;
  
  isDragging = true;
  const rect = canvas.getBoundingClientRect();
  dragStartX = e.clientX - rect.left;
  dragStartY = e.clientY - rect.top;
  
  // Determine if dragging text or image
  const canvasX = (dragStartX / rect.width) * canvas.width;
  const canvasY = (dragStartY / rect.height) * canvas.height;
  dragType = 'group';
  
  canvas.style.cursor = 'grabbing';
});

canvas.addEventListener('mousemove', e => {
  if(!isDragging || !activeLayerId) return;
  
  const layer = layers.find(l => l.id === activeLayerId);
  if(!layer) return;
  
  const rect = canvas.getBoundingClientRect();
  const currentX = e.clientX - rect.left;
  const currentY = e.clientY - rect.top;
  
  const deltaX = ((currentX - dragStartX) / rect.width) * canvas.width;
  const deltaY = ((currentY - dragStartY) / rect.height) * canvas.height;
  
  if(dragType === 'group'){
    layer.x += deltaX;
    layer.y += deltaY;
    document.getElementById('groupX').value = layer.x;
    document.getElementById('groupY').value = layer.y;
    document.getElementById('groupXVal').textContent = Math.round(layer.x) + 'px';
    document.getElementById('groupYVal').textContent = Math.round(layer.y) + 'px';
  }
  
  dragStartX = currentX;
  dragStartY = currentY;
  redraw();
});

canvas.addEventListener('mouseup', () => {
  isDragging = false;
  canvas.style.cursor = 'grab';
});

canvas.addEventListener('mouseleave', () => {
  isDragging = false;
  canvas.style.cursor = 'grab';
});

function redraw(){
  const bgColor = document.getElementById("bgColor").value;
  ctx.fillStyle = bgColor;
  ctx.fillRect(0,0,canvas.width,canvas.height);

  layers.forEach(layer => {
    if(layer.type === "group"){
      drawGroup(layer);
    }
  });
}

function drawGroup(layer){
  ctx.save();
  ctx.globalAlpha = layer.opacity;
  ctx.translate(canvas.width/2 + layer.x, canvas.height/2 + layer.y);
  ctx.rotate(layer.rotate * Math.PI / 180);
  ctx.scale(layer.scale, layer.scale);

  // Draw background image
  if(layer.image){
    ctx.save();
    ctx.globalAlpha = layer.opacity * layer.imgOpacity;
    
    if(layer.imgBlur > 0){
      ctx.filter = `blur(${layer.imgBlur}px)`;
    }

    ctx.translate(layer.imgPosX, layer.imgPosY);
    ctx.scale(layer.imgScale, layer.imgScale);

    const ratio = layer.image.width / layer.image.height;
    const canvasRatio = canvas.width / canvas.height;
    let w, h, x, y;
    
    if(layer.imgFit === "cover"){
      if(canvasRatio > ratio){
        w = canvas.width;
        h = w / ratio;
      } else {
        h = canvas.height;
        w = h * ratio;
      }
    } else if(layer.imgFit === "contain"){
      if(canvasRatio < ratio){
        w = canvas.width;
        h = w / ratio;
      } else {
        h = canvas.height;
        w = h * ratio;
      }
    } else {
      w = canvas.width;
      h = canvas.height;
    }

    x = -w / 2;
    y = -h / 2;

    ctx.drawImage(layer.image, x, y, w, h);
    ctx.restore();
  }

  // Draw text
  ctx.globalAlpha = layer.opacity;
  ctx.font = `${layer.fontWeight} ${layer.fontSize}px ${layer.fontFamily}`;
  ctx.textAlign = layer.textAlign;
  ctx.textBaseline = "middle";

  const lines = layer.text.split('\n');
  const lineHeightPx = layer.fontSize * layer.lineHeight;

  lines.forEach((line, i) => {
    const yOffset = layer.textY + (i - (lines.length - 1) / 2) * lineHeightPx;
    
    // Text background
    if(layer.textBgOpacity > 0){
      const metrics = ctx.measureText(line);
      const padding = layer.textBgPadding;
      let bgX;
      
      if(layer.textAlign === "center"){
        bgX = layer.textX - metrics.width / 2 - padding;
      } else if(layer.textAlign === "right"){
        bgX = layer.textX - metrics.width - padding;
      } else {
        bgX = layer.textX - padding;
      }

      const alpha = Math.round(layer.textBgOpacity * 255).toString(16).padStart(2, '0');
      ctx.fillStyle = layer.textBgColor + alpha;
      ctx.fillRect(
        bgX,
        yOffset - layer.fontSize / 2 - padding,
        metrics.width + padding * 2,
        layer.fontSize + padding * 2
      );
    }

    // Shadow
    if(layer.shadowBlur > 0){
      ctx.shadowBlur = layer.shadowBlur;
      ctx.shadowOffsetX = layer.shadowX;
      ctx.shadowOffsetY = layer.shadowY;
      ctx.shadowColor = layer.shadowColor;
    }

    // Stroke
    if(layer.strokeWidth > 0){
      ctx.strokeStyle = layer.strokeColor;
      ctx.lineWidth = layer.strokeWidth;
      ctx.lineJoin = "round";
      ctx.strokeText(line, layer.textX, yOffset);
    }

    // Text fill
    ctx.fillStyle = layer.textColor;
    ctx.fillText(line, layer.textX, yOffset);
    
    ctx.shadowBlur = 0;
    ctx.shadowOffsetX = 0;
    ctx.shadowOffsetY = 0;
  });

  ctx.restore();
}

function addLayer(type){
  const id = Date.now();
  const layer = {
    id,
    type: "group",
    name: `Group ${layers.length + 1}`
  };

  layer.image = null;
  layer.text = "YOUR TEXT HERE";
  layer.x = 0;
  layer.y = 0;
  layer.scale = 1;
  layer.rotate = 0;
  layer.opacity = 1;
  layer.imgPosX = 0;
  layer.imgPosY = 0;
  layer.imgScale = 1;
  layer.imgOpacity = 1;
  layer.imgBlur = 0;
  layer.imgFit = "cover";
  layer.textX = 0;
  layer.textY = 0;
  layer.fontSize = 64;
  layer.fontFamily = "Arial";
  layer.fontWeight = "900";
  layer.textColor = "#ffffff";
  layer.textAlign = "center";
  layer.lineHeight = 1.2;
  layer.textBgColor = "#000000";
  layer.textBgOpacity = 0;
  layer.textBgPadding = 20;
  layer.strokeWidth = 0;
  layer.strokeColor = "#000000";
  layer.shadowBlur = 10;
  layer.shadowX = 0;
  layer.shadowY = 0;
  layer.shadowColor = "#000000";

  layers.push(layer);
  selectLayer(id);
  updateLayersList();
  redraw();
}

function selectLayer(id){
  activeLayerId = id;
  updateLayersList();
  updatePropertyPanel();
}

function deleteLayer(){
  if(!activeLayerId) return;
  layers = layers.filter(l => l.id !== activeLayerId);
  activeLayerId = null;
  updateLayersList();
  updatePropertyPanel();
  redraw();
}

function updateLayersList(){
  const container = document.getElementById("layers");
  container.innerHTML = layers.map(layer => `
    <div class="layer-item ${layer.id === activeLayerId ? 'active' : ''}" 
         onclick="selectLayer(${layer.id})">
      <span>${layer.name}</span>
      <span class="layer-badge">group</span>
    </div>
  `).join('');
}

function updatePropertyPanel(){
  const panel = document.getElementById("propertyPanel");

  if(!activeLayerId){
    panel.style.display = "none";
    return;
  }

  panel.style.display = "block";
  const layer = layers.find(l => l.id === activeLayerId);
  loadGroupProps(layer);
}

function loadGroupProps(layer){
  const bindings = [
    ['groupX', 'x', v => Math.round(v) + 'px'],
    ['groupY', 'y', v => Math.round(v) + 'px'],
    ['groupScale', 'scale', v => v.toFixed(2)],
    ['groupRotate', 'rotate', v => Math.round(v) + '¬∞'],
    ['groupOpacity', 'opacity', v => Math.round(v * 100) + '%'],
    ['imgPosX', 'imgPosX', v => Math.round(v) + 'px'],
    ['imgPosY', 'imgPosY', v => Math.round(v) + 'px'],
    ['imgScale', 'imgScale', v => v.toFixed(2)],
    ['imgOpacity', 'imgOpacity', v => Math.round(v * 100) + '%'],
    ['imgBlur', 'imgBlur', v => Math.round(v) + 'px'],
    ['textX', 'textX', v => Math.round(v) + 'px'],
    ['textY', 'textY', v => Math.round(v) + 'px'],
    ['groupFontSize', 'fontSize', v => Math.round(v) + 'px'],
    ['lineHeight', 'lineHeight', v => v.toFixed(1)],
    ['textBgOpacity', 'textBgOpacity', v => Math.round(v * 100) + '%'],
    ['textBgPadding', 'textBgPadding', v => Math.round(v) + 'px'],
    ['strokeWidth', 'strokeWidth', v => Math.round(v) + 'px'],
    ['shadowBlur', 'shadowBlur', v => Math.round(v) + 'px'],
    ['shadowX', 'shadowX', v => Math.round(v) + 'px'],
    ['shadowY', 'shadowY', v => Math.round(v) + 'px']
  ];

  bindings.forEach(([id, prop, format]) => {
    const el = document.getElementById(id);
    if(!el) return;
    el.value = layer[prop];
    const valEl = document.getElementById(id + 'Val');
    if(valEl) valEl.textContent = format(layer[prop]);
    el.oninput = e => {
      layer[prop] = Number(e.target.value);
      if(valEl) valEl.textContent = format(layer[prop]);
      redraw();
    };
  });

  const simpleBindings = [
    ['groupText', 'text'],
    ['groupFontFamily', 'fontFamily'],
    ['groupFontWeight', 'fontWeight'],
    ['groupTextColor', 'textColor'],
    ['textAlign', 'textAlign'],
    ['textBgColor', 'textBgColor'],
    ['strokeColor', 'strokeColor'],
    ['shadowColor', 'shadowColor'],
    ['imgFit', 'imgFit']
  ];

  simpleBindings.forEach(([id, prop]) => {
    const el = document.getElementById(id);
    if(!el) return;
    el.value = layer[prop];
    el.oninput = e => {
      layer[prop] = e.target.value;
      redraw();
    };
  });

  document.getElementById('groupImgUpload').onchange = e => {
    const file = e.target.files[0];
    if(!file) return;
    const reader = new FileReader();
    reader.onload = () => {
      const img = new Image();
      img.onload = () => {
        layer.image = img;
        redraw();
      };
      img.src = reader.result;
    };
    reader.readAsDataURL(file);
  };
}

function loadMusic(){
  const url = document.getElementById('musicUrl').value.trim();
  if(!url){
    alert('Please enter a music URL');
    return;
  }
  
  audioPlayer.src = url;
  audioPlayer.load();
  audioPlayer.onloadeddata = () => {
    musicLoaded = true;
    musicControls.style.display = 'block';
    alert('Music loaded successfully!');
  };
  audioPlayer.onerror = () => {
    alert('Failed to load music. Make sure the URL is a direct link to an audio file.');
  };
}

function clearMusic(){
  audioPlayer.src = '';
  musicLoaded = false;
  musicControls.style.display = 'none';
  document.getElementById('musicUrl').value = '';
}

function setCanvasSize(w, h){
  canvas.width = w;
  canvas.height = h;
  redraw();
}

document.getElementById('bgColor').oninput = redraw;

function play(){
  if(isPlaying) return;
  isPlaying = true;
  const fps = Number(document.getElementById('fps').value);
  const duration = Number(document.getElementById('duration').value);
  
  if(musicLoaded){
    audioPlayer.currentTime = 0;
    audioPlayer.play();
  }
  
  function animate(){
    if(!isPlaying) return;
    currentTime += 1 / fps;
    if(currentTime >= duration){
      currentTime = 0;
      isPlaying = false;
      if(musicLoaded) audioPlayer.pause();
      return;
    }
    document.getElementById('timeDisplay').textContent = currentTime.toFixed(1) + 's';
    redraw();
    animationId = requestAnimationFrame(animate);
  }
  animate();
}

function pause(){
  isPlaying = false;
  if(animationId) cancelAnimationFrame(animationId);
  if(musicLoaded) audioPlayer.pause();
}

function reset(){
  pause();
  currentTime = 0;
  document.getElementById('timeDisplay').textContent = '0.0s';
  if(musicLoaded) audioPlayer.currentTime = 0;
  redraw();
}

function showStatus(msg){
  const status = document.getElementById('status');
  status.innerHTML = `<span class="loader"></span>${msg}`;
  status.classList.add('show');
}

function hideStatus(){
  document.getElementById('status').classList.remove('show');
}

async function exportVideo(format){
  showStatus(`Rendering ${format.toUpperCase()} video...`);
  
  const fps = Number(document.getElementById('fps').value);
  const duration = Number(document.getElementById('duration').value);
  const totalFrames = fps * duration;

  try {
    const stream = canvas.captureStream(fps);
    
    let audioTracks = [];
    if(musicLoaded){
      const audioCtx = new AudioContext();
      const dest = audioCtx.createMediaStreamDestination();
      const source = audioCtx.createMediaElementSource(audioPlayer);
      source.connect(dest);
      source.connect(audioCtx.destination);
      audioTracks = dest.stream.getAudioTracks();
    }
    
    const videoTrack = stream.getVideoTracks()[0];
    const finalStream = new MediaStream([videoTrack, ...audioTracks]);
    
    const recorder = new MediaRecorder(finalStream, {
      mimeType: 'video/webm;codecs=vp9,opus',
      videoBitsPerSecond: 5000000
    });
    
    const chunks = [];
    recorder.ondataavailable = e => chunks.push(e.data);
    
    recorder.start();
    
    if(musicLoaded){
      audioPlayer.currentTime = 0;
      audioPlayer.play();
    }

    for(let i = 0; i < totalFrames; i++){
      currentTime = i / fps;
      document.getElementById('timeDisplay').textContent = currentTime.toFixed(1) + 's';
      redraw();
      await new Promise(resolve => setTimeout(resolve, 1000 / fps));
    }

    if(musicLoaded) audioPlayer.pause();
    recorder.stop();
    
    recorder.onstop = () => {
      const blob = new Blob(chunks, {type: 'video/webm'});
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a');
      a.href = url;
      a.download = `video-${Date.now()}.${format}`;
      a.click();
      URL.revokeObjectURL(url);
      
      reset();
      hideStatus();
      alert('Video exported successfully with ' + (musicLoaded ? 'audio!' : 'no audio!'));
    };
  } catch(error){
    hideStatus();
    alert('Export failed: ' + error.message);
  }
}
</script>

</body>
</html>
