<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>CapCut Video Editor</title>
<meta name="viewport" content="width=device-width, initial-scale=1">
<style>
* {
  box-sizing: border-box;
  margin: 0;
  padding: 0;
}

body {
  background: #1a1a1a;
  color: #e5e7eb;
  font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
  overflow: hidden;
  height: 100vh;
}

.editor-container {
  display: flex;
  flex-direction: column;
  height: 100vh;
}

.top-bar {
  background: #0a0a0a;
  border-bottom: 1px solid #333;
  padding: 8px 16px;
  display: flex;
  justify-content: space-between;
  align-items: center;
  height: 56px;
}

.logo {
  font-size: 18px;
  font-weight: 700;
  background: linear-gradient(135deg, #00d4ff, #ff00d4);
  -webkit-background-clip: text;
  -webkit-text-fill-color: transparent;
}

.top-actions {
  display: flex;
  gap: 10px;
  align-items: center;
}

.btn {
  padding: 7px 16px;
  border: none;
  border-radius: 6px;
  font-size: 13px;
  font-weight: 600;
  cursor: pointer;
  transition: all 0.2s;
}

.btn-primary {
  background: linear-gradient(135deg, #00d4ff, #0099ff);
  color: #fff;
}

.btn-primary:hover {
  transform: translateY(-1px);
  box-shadow: 0 4px 12px rgba(0, 212, 255, 0.4);
}

.btn-secondary {
  background: #2a2a2a;
  color: #fff;
  border: 1px solid #444;
}

.btn-secondary:hover {
  background: #333;
}

.main-content {
  display: flex;
  flex: 1;
  overflow: hidden;
}

.left-panel {
  width: 260px;
  background: #0f0f0f;
  border-right: 1px solid #333;
  display: flex;
  flex-direction: column;
  overflow-y: auto;
}

.left-panel::-webkit-scrollbar {
  width: 5px;
}

.left-panel::-webkit-scrollbar-track {
  background: #1a1a1a;
}

.left-panel::-webkit-scrollbar-thumb {
  background: #00d4ff;
  border-radius: 3px;
}

.tool-section {
  padding: 14px;
  border-bottom: 1px solid #2a2a2a;
}

.section-title {
  font-size: 12px;
  font-weight: 600;
  color: #fff;
  margin-bottom: 10px;
  text-transform: uppercase;
  letter-spacing: 0.5px;
}

.tool-btn {
  width: 100%;
  padding: 10px;
  background: #1a1a1a;
  border: 1px solid #333;
  border-radius: 6px;
  color: #e5e7eb;
  cursor: pointer;
  display: flex;
  align-items: center;
  gap: 8px;
  font-size: 12px;
  transition: all 0.2s;
  margin-bottom: 6px;
}

.tool-btn:hover {
  background: #2a2a2a;
  border-color: #00d4ff;
}

.tool-icon {
  font-size: 18px;
}

.canvas-area {
  flex: 1;
  display: flex;
  flex-direction: column;
  background: #161616;
  position: relative;
  min-width: 0;
}

.pages-container {
  display: flex;
  gap: 6px;
  padding: 8px 10px;
  background: #0f0f0f;
  border-bottom: 1px solid #333;
  overflow-x: auto;
}

.page-thumb {
  min-width: 60px;
  height: 45px;
  background: #1a1a1a;
  border: 2px solid #333;
  border-radius: 5px;
  cursor: pointer;
  display: flex;
  align-items: center;
  justify-content: center;
  font-size: 10px;
  color: #666;
  transition: all 0.2s;
  position: relative;
}

.page-thumb:hover {
  border-color: #00d4ff;
}

.page-thumb.active {
  border-color: #00d4ff;
  background: #1a2a3a;
  color: #00d4ff;
}

.page-duration {
  position: absolute;
  bottom: 2px;
  right: 2px;
  font-size: 8px;
  background: #000;
  padding: 1px 3px;
  border-radius: 2px;
}

.add-page-btn {
  min-width: 60px;
  height: 45px;
  background: #1a1a1a;
  border: 2px dashed #444;
  border-radius: 5px;
  cursor: pointer;
  display: flex;
  align-items: center;
  justify-content: center;
  font-size: 18px;
  color: #666;
  transition: all 0.2s;
}

.add-page-btn:hover {
  border-color: #00d4ff;
  color: #00d4ff;
}

.canvas-controls {
  padding: 6px 10px;
  background: #0f0f0f;
  border-bottom: 1px solid #333;
  display: flex;
  align-items: center;
  gap: 10px;
}

.zoom-controls {
  display: flex;
  align-items: center;
  gap: 5px;
  margin-left: auto;
}

.zoom-btn {
  width: 26px;
  height: 26px;
  background: #2a2a2a;
  border: 1px solid #444;
  border-radius: 5px;
  color: #fff;
  cursor: pointer;
  font-size: 13px;
}

.zoom-btn:hover {
  background: #333;
}

.zoom-level {
  min-width: 45px;
  text-align: center;
  font-size: 11px;
  color: #999;
}

.canvas-viewport {
  flex: 1;
  display: flex;
  align-items: center;
  justify-content: center;
  overflow: auto;
  position: relative;
  background: 
    repeating-linear-gradient(0deg, transparent, transparent 19px, #1a1a1a 19px, #1a1a1a 20px),
    repeating-linear-gradient(90deg, transparent, transparent 19px, #1a1a1a 19px, #1a1a1a 20px);
  background-size: 20px 20px;
}

.canvas-wrapper {
  position: relative;
  transform-origin: center center;
  transition: transform 0.2s;
}

canvas {
  display: block;
  box-shadow: 0 8px 32px rgba(0, 0, 0, 0.8);
  cursor: default;
  max-width: 350px;
  max-height: 450px;
}

.right-panel {
  width: 300px;
  background: #0f0f0f;
  border-left: 1px solid #333;
  display: flex;
  flex-direction: column;
  max-height: calc(100vh - 56px - 280px);
  overflow-y: auto;
}

.right-panel::-webkit-scrollbar {
  width: 5px;
}

.right-panel::-webkit-scrollbar-track {
  background: #1a1a1a;
}

.right-panel::-webkit-scrollbar-thumb {
  background: #00d4ff;
  border-radius: 3px;
}

.panel-section {
  padding: 12px;
  border-bottom: 1px solid #2a2a2a;
}

.property-row {
  margin-bottom: 10px;
}

.property-label {
  display: flex;
  justify-content: space-between;
  font-size: 11px;
  color: #999;
  margin-bottom: 5px;
}

.property-value {
  color: #00d4ff;
  font-weight: 600;
}

input[type="range"] {
  width: 100%;
  height: 3px;
  background: #2a2a2a;
  border-radius: 2px;
  outline: none;
  -webkit-appearance: none;
}

input[type="range"]::-webkit-slider-thumb {
  -webkit-appearance: none;
  width: 11px;
  height: 11px;
  background: #00d4ff;
  border-radius: 50%;
  cursor: pointer;
}

input[type="range"]::-moz-range-thumb {
  width: 11px;
  height: 11px;
  background: #00d4ff;
  border-radius: 50%;
  cursor: pointer;
  border: none;
}

input[type="text"],
input[type="number"],
input[type="url"],
textarea,
select {
  width: 100%;
  padding: 6px 8px;
  background: #1a1a1a;
  color: #e5e7eb;
  border: 1px solid #333;
  border-radius: 5px;
  font-size: 11px;
  font-family: inherit;
}

input:focus,
textarea:focus,
select:focus {
  outline: none;
  border-color: #00d4ff;
}

textarea {
  resize: vertical;
  min-height: 45px;
}

input[type="color"] {
  width: 100%;
  height: 30px;
  padding: 2px;
  border: 1px solid #333;
  border-radius: 5px;
  background: #1a1a1a;
  cursor: pointer;
}

input[type="file"] {
  font-size: 10px;
  padding: 4px;
  cursor: pointer;
}

.preset-grid {
  display: grid;
  grid-template-columns: repeat(2, 1fr);
  gap: 5px;
  margin-top: 6px;
}

.preset-btn {
  padding: 8px 5px;
  background: #1a1a1a;
  border: 1px solid #333;
  border-radius: 5px;
  color: #e5e7eb;
  cursor: pointer;
  font-size: 10px;
  text-align: center;
  transition: all 0.2s;
}

.preset-btn:hover {
  background: #2a2a2a;
  border-color: #00d4ff;
}

.preset-btn small {
  display: block;
  color: #666;
  margin-top: 2px;
  font-size: 8px;
}

.timeline {
  height: 280px;
  background: #0a0a0a;
  border-top: 1px solid #333;
  display: flex;
  flex-direction: column;
}

.timeline-header {
  padding: 6px 10px;
  background: #0f0f0f;
  border-bottom: 1px solid #333;
  display: flex;
  align-items: center;
  gap: 8px;
}

.playback-controls {
  display: flex;
  gap: 5px;
}

.play-btn {
  width: 28px;
  height: 28px;
  background: #00d4ff;
  border: none;
  border-radius: 50%;
  color: #000;
  cursor: pointer;
  font-size: 12px;
  display: flex;
  align-items: center;
  justify-content: center;
}

.play-btn:hover {
  background: #00b8e6;
}

.time-display {
  font-size: 11px;
  color: #999;
  font-variant-numeric: tabular-nums;
  min-width: 85px;
}

.timeline-content {
  flex: 1;
  padding: 8px;
  overflow-x: auto;
  overflow-y: auto;
  position: relative;
}

.timeline-ruler {
  height: 20px;
  background: #0f0f0f;
  border-bottom: 1px solid #333;
  position: relative;
  margin-bottom: 8px;
}

.timeline-tracks {
  display: flex;
  flex-direction: column;
  gap: 4px;
}

.track {
  background: #1a1a1a;
  border-radius: 4px;
  padding: 4px;
  min-height: 50px;
  display: flex;
  align-items: stretch;
  gap: 4px;
  position: relative;
}

.track-label {
  font-size: 9px;
  color: #666;
  writing-mode: vertical-rl;
  text-align: center;
  padding: 4px;
  background: #0f0f0f;
  border-radius: 3px;
}

.track-content {
  flex: 1;
  position: relative;
  min-height: 42px;
}

.track-item {
  position: absolute;
  background: linear-gradient(135deg, #00d4ff, #0099ff);
  border-radius: 3px;
  padding: 4px 6px;
  font-size: 9px;
  color: #fff;
  cursor: move;
  min-width: 60px;
  height: 38px;
  display: flex;
  flex-direction: column;
  justify-content: space-between;
  border: 2px solid transparent;
  transition: all 0.2s;
  overflow: hidden;
}

.track-item:hover {
  border-color: #fff;
  z-index: 10;
}

.track-item.selected {
  border-color: #00d4ff;
  box-shadow: 0 0 8px rgba(0, 212, 255, 0.5);
  z-index: 20;
}

.track-item.audio {
  background: linear-gradient(135deg, #ff00d4, #ff0080);
}

.track-item.image {
  background: linear-gradient(135deg, #00ff88, #00cc66);
}

.track-item.text {
  background: linear-gradient(135deg, #ffaa00, #ff8800);
}

.item-name {
  font-weight: 600;
  white-space: nowrap;
  overflow: hidden;
  text-overflow: ellipsis;
}

.item-duration {
  font-size: 8px;
  opacity: 0.8;
}

.item-handle {
  position: absolute;
  top: 0;
  bottom: 0;
  width: 8px;
  cursor: ew-resize;
  background: rgba(255, 255, 255, 0.1);
}

.item-handle.left {
  left: 0;
}

.item-handle.right {
  right: 0;
}

.layer-list {
  margin-top: 8px;
}

.layer-item {
  background: #1a1a1a;
  border: 2px solid transparent;
  border-radius: 5px;
  padding: 8px;
  margin-bottom: 4px;
  cursor: pointer;
  display: flex;
  justify-content: space-between;
  align-items: center;
  transition: all 0.2s;
  font-size: 11px;
}

.layer-item:hover {
  background: #2a2a2a;
}

.layer-item.active {
  border-color: #00d4ff;
  background: #1a2a3a;
}

.layer-badge {
  font-size: 8px;
  padding: 2px 5px;
  background: #2a2a2a;
  border-radius: 3px;
  text-transform: uppercase;
}

.help-text {
  font-size: 9px;
  color: #666;
  margin-top: 2px;
  font-style: italic;
}

.status-toast {
  position: fixed;
  bottom: 300px;
  right: 320px;
  background: #1a1a1a;
  padding: 8px 14px;
  border-radius: 6px;
  border: 1px solid #333;
  display: none;
  box-shadow: 0 4px 12px rgba(0, 0, 0, 0.5);
  z-index: 1000;
  font-size: 11px;
}

.status-toast.show {
  display: flex;
  align-items: center;
  gap: 6px;
}

.loader {
  width: 10px;
  height: 10px;
  border: 2px solid #00d4ff;
  border-top-color: transparent;
  border-radius: 50%;
  animation: spin 0.8s linear infinite;
}

@keyframes spin {
  to { transform: rotate(360deg); }
}

.animation-presets {
  display: grid;
  grid-template-columns: repeat(2, 1fr);
  gap: 4px;
  margin-top: 6px;
}

.anim-btn {
  padding: 6px 4px;
  background: #1a1a1a;
  border: 1px solid #333;
  border-radius: 4px;
  color: #e5e7eb;
  cursor: pointer;
  font-size: 9px;
  text-align: center;
  transition: all 0.2s;
}

.anim-btn:hover {
  background: #2a2a2a;
  border-color: #00d4ff;
}

.anim-btn.active {
  background: #1a2a3a;
  border-color: #00d4ff;
}
</style>
</head>
<body>

<div class="editor-container">
  <div class="top-bar">
    <div class="logo">‚úÇÔ∏è CapCut</div>
    <div class="top-actions">
      <select id="canvasSizeSelect" style="padding: 5px 8px; background: #2a2a2a; border: 1px solid #444; border-radius: 5px; color: #fff; cursor: pointer; font-size: 11px;">
        <option value="1080,1920">9:16 Portrait</option>
        <option value="1920,1080">16:9 Landscape</option>
        <option value="1080,1080">1:1 Square</option>
        <option value="720,1280">9:16 HD</option>
      </select>
      <button class="btn btn-primary" onclick="exportAllPages()">üì§ Export</button>
    </div>
  </div>

  <div class="main-content">
    <div class="left-panel">
      <div class="tool-section">
        <div class="section-title">üìê Canvas</div>
        <div class="preset-grid">
          <div class="preset-btn" onclick="setCanvasSize(1080,1920)">9:16<br><small>1080√ó1920</small></div>
          <div class="preset-btn" onclick="setCanvasSize(1920,1080)">16:9<br><small>1920√ó1080</small></div>
          <div class="preset-btn" onclick="setCanvasSize(1080,1080)">1:1<br><small>1080√ó1080</small></div>
          <div class="preset-btn" onclick="setCanvasSize(720,1280)">HD<br><small>720√ó1280</small></div>
        </div>
        <div class="property-row" style="margin-top: 8px;">
          <div class="property-label">Background</div>
          <input type="color" id="bgColor" value="#000000">
        </div>
      </div>

      <div class="tool-section">
        <div class="section-title">üéµ Music</div>
        <input type="url" id="musicUrl" placeholder="Audio URL..." style="margin-bottom: 5px;">
        <button class="tool-btn" onclick="loadMusic()">
          <span class="tool-icon">üéµ</span>
          <span>Load Music</span>
        </button>
        <audio id="audioPlayer" controls style="width: 100%; margin-top: 5px; display: none; height: 28px;"></audio>
      </div>

      <div class="tool-section">
        <div class="section-title">‚ûï Add Elements</div>
        <button class="tool-btn" onclick="addElement('image')">
          <span class="tool-icon">üñºÔ∏è</span>
          <span>Add Image</span>
        </button>
        <button class="tool-btn" onclick="addElement('text')">
          <span class="tool-icon">üí¨</span>
          <span>Add Text</span>
        </button>
      </div>

      <div class="tool-section">
        <div class="section-title">üé¨ Layers (Page <span id="currentPageNum">1</span>)</div>
        <div class="layer-list" id="layersList"></div>
      </div>
    </div>

    <div class="canvas-area">
      <div class="pages-container" id="pagesContainer">
        <div class="page-thumb active" onclick="switchPage(0)">
          <span>Page 1</span>
          <div class="page-duration">5s</div>
        </div>
        <div class="add-page-btn" onclick="addPage()">+</div>
      </div>

      <div class="canvas-controls">
        <span style="font-size: 10px; color: #999;">Canvas</span>
        <div class="zoom-controls">
          <button class="zoom-btn" onclick="zoomOut()">‚àí</button>
          <div class="zoom-level" id="zoomLevel">100%</div>
          <button class="zoom-btn" onclick="zoomIn()">+</button>
          <button class="zoom-btn" onclick="resetZoom()" title="Reset">‚äô</button>
        </div>
      </div>

      <div class="canvas-viewport" id="canvasViewport">
        <div class="canvas-wrapper" id="canvasWrapper">
          <canvas id="canvas"></canvas>
        </div>
      </div>
    </div>

    <div class="right-panel" id="rightPanel">
      <div id="elementProperties" style="display: none;">
        <div class="panel-section" id="imageProps" style="display: none;">
          <div class="section-title">üñºÔ∏è Image</div>
          <input type="file" id="imageUpload" accept="image/*">
          <p class="help-text">Upload image for this layer</p>
          
          <div class="property-row">
            <div class="property-label">
              <span>Width</span>
              <span class="property-value" id="imgWidthVal">540</span>
            </div>
            <input type="range" id="imgWidth" min="50" max="2000" value="540">
          </div>
          <div class="property-row">
            <div class="property-label">
              <span>Height</span>
              <span class="property-value" id="imgHeightVal">540</span>
            </div>
            <input type="range" id="imgHeight" min="50" max="2000" value="540">
          </div>
          <div class="property-row">
            <div class="property-label">
              <span>Opacity</span>
              <span class="property-value" id="imgOpacityVal">100%</span>
            </div>
            <input type="range" id="imgOpacity" min="0" max="1" step="0.01" value="1">
          </div>
        </div>

        <div class="panel-section" id="textProps" style="display: none;">
          <div class="section-title">üí¨ Text</div>
          <textarea id="textContent" placeholder="Enter text...">YOUR TEXT</textarea>
          <div class="property-row" style="margin-top: 8px;">
            <div class="property-label">
              <span>Font Size</span>
              <span class="property-value" id="fontSizeVal">64</span>
            </div>
            <input type="range" id="fontSize" min="12" max="200" value="64">
          </div>
          <div class="property-row">
            <div class="property-label">Font</div>
            <select id="fontFamily">
              <option value="Arial">Arial</option>
              <option value="Helvetica">Helvetica</option>
              <option value="Impact">Impact</option>
              <option value="Georgia">Georgia</option>
            </select>
          </div>
          <div class="property-row">
            <div class="property-label">Color</div>
            <input type="color" id="textColor" value="#ffffff">
          </div>
        </div>

        <div class="panel-section">
          <div class="section-title">üìç Position</div>
          <div class="property-row">
            <div class="property-label">
              <span>X</span>
              <span class="property-value" id="posXVal">0</span>
            </div>
            <input type="range" id="posX" min="-1000" max="1000" value="0">
          </div>
          <div class="property-row">
            <div class="property-label">
              <span>Y</span>
              <span class="property-value" id="posYVal">0</span>
            </div>
            <input type="range" id="posY" min="-1000" max="1000" value="0">
          </div>
        </div>

        <div class="panel-section">
          <div class="section-title">üé® Transform</div>
          <div class="property-row">
            <div class="property-label">
              <span>Scale</span>
              <span class="property-value" id="scaleVal">1.0</span>
            </div>
            <input type="range" id="scale" min="0.1" max="3" step="0.01" value="1">
          </div>
          <div class="property-row">
            <div class="property-label">
              <span>Rotation</span>
              <span class="property-value" id="rotateVal">0¬∞</span>
            </div>
            <input type="range" id="rotate" min="-180" max="180" value="0">
          </div>
          <div class="property-row">
            <div class="property-label">
              <span>Opacity</span>
              <span class="property-value" id="opacityVal">100%</span>
            </div>
            <input type="range" id="opacity" min="0" max="1" step="0.01" value="1">
          </div>
        </div>

        <div class="panel-section">
          <div class="section-title">‚è±Ô∏è Timing</div>
          <div class="property-row">
            <div class="property-label">
              <span>Start Time (s)</span>
              <span class="property-value" id="startTimeVal">0.0</span>
            </div>
            <input type="range" id="startTime" min="0" max="30" step="0.1" value="0">
          </div>
          <div class="property-row">
            <div class="property-label">
              <span>Duration (s)</span>
              <span class="property-value" id="durationVal">5.0</span>
            </div>
            <input type="range" id="duration" min="0.1" max="30" step="0.1" value="5">
          </div>
        </div>

        <div class="panel-section">
          <div class="section-title">‚ú® Animation</div>
          <div class="animation-presets">
            <div class="anim-btn" onclick="setAnimation('none')">None</div>
            <div class="anim-btn" onclick="setAnimation('fadeIn')">Fade In</div>
            <div class="anim-btn" onclick="setAnimation('fadeOut')">Fade Out</div>
            <div class="anim-btn" onclick="setAnimation('slideLeft')">Slide Left</div>
            <div class="anim-btn" onclick="setAnimation('slideRight')">Slide Right</div>
            <div class="anim-btn" onclick="setAnimation('slideUp')">Slide Up</div>
            <div class="anim-btn" onclick="setAnimation('slideDown')">Slide Down</div>
            <div class="anim-btn" onclick="setAnimation('zoomIn')">Zoom In</div>
            <div class="anim-btn" onclick="setAnimation('zoomOut')">Zoom Out</div>
            <div class="anim-btn" onclick="setAnimation('rotate')">Rotate</div>
          </div>
          <div class="property-row" style="margin-top: 8px;">
            <div class="property-label">
              <span>Speed</span>
              <span class="property-value" id="animSpeedVal">1.0</span>
            </div>
            <input type="range" id="animSpeed" min="0.1" max="3" step="0.1" value="1">
          </div>
        </div>

        <div class="panel-section">
          <button class="btn btn-secondary" style="width: 100%; background: #dc2626;" onclick="deleteElement()">üóë Delete</button>
        </div>
      </div>
    </div>
  </div>

  <div class="timeline">
    <div class="timeline-header">
      <div class="playback-controls">
        <button class="play-btn" onclick="play()">‚ñ∂</button>
        <button class="btn btn-secondary" style="padding: 4px 8px; font-size: 11px;" onclick="pause()">‚è∏</button>
        <button class="btn btn-secondary" style="padding: 4px 8px; font-size: 11px;" onclick="reset()">‚èÆ</button>
      </div>
      <div class="time-display" id="timeDisplay">00:00 / 05:00</div>
      <div style="flex: 1;"></div>
      <input type="number" id="pageDuration" value="5" min="1" max="30" style="width: 60px; padding: 4px 5px; text-align: center; font-size: 11px;" placeholder="Sec">
      <span style="font-size: 10px; color: #999;">sec</span>
    </div>
    <div class="timeline-content">
      <div class="timeline-ruler" id="timelineRuler"></div>
      <div class="timeline-tracks" id="timelineTracks"></div>
    </div>
  </div>
</div>

<div class="status-toast" id="statusToast">
  <div class="loader"></div>
  <span id="statusText"></span>
</div>

<script>
const canvas = document.getElementById('canvas');
const ctx = canvas.getContext('2d');
const canvasWrapper = document.getElementById('canvasWrapper');
const audioPlayer = document.getElementById('audioPlayer');

let pages = [{
  elements: [],
  duration: 5
}];

let currentPageIndex = 0;
let activeElementId = null;
let zoomLevel = 1;
let isPlaying = false;
let currentTime = 0;
let animationId = null;
let musicLoaded = false;
let isDraggingTimeline = false;
let draggedItem = null;
let dragStartX = 0;

canvas.width = 1080;
canvas.height = 1920;

redraw();
updateLayersList();
updateTimeline();

function getCurrentPage() {
  return pages[currentPageIndex];
}

function redraw() {
  const bgColor = document.getElementById('bgColor').value;
  ctx.fillStyle = bgColor;
  ctx.fillRect(0, 0, canvas.width, canvas.height);

  const page = getCurrentPage();
  const visibleElements = page.elements.filter(el => {
    return currentTime >= el.startTime && currentTime <= (el.startTime + el.duration);
  });

  visibleElements.forEach(element => {
    const elapsed = currentTime - element.startTime;
    const progress = elapsed / element.duration;

    ctx.save();
    
    let animX = element.x;
    let animY = element.y;
    let animScale = element.scale;
    let animRotate = element.rotate;
    let animOpacity = element.opacity;

    // Apply animation
    const animDuration = 0.5 / element.animSpeed;
    const animProgress = Math.min(elapsed / animDuration, 1);
    
    if (element.animation === 'fadeIn') {
      animOpacity *= animProgress;
    } else if (element.animation === 'fadeOut') {
      animOpacity *= (1 - Math.max((progress - 0.7) / 0.3, 0));
    } else if (element.animation === 'slideLeft') {
      animX += (1 - animProgress) * 500;
    } else if (element.animation === 'slideRight') {
      animX -= (1 - animProgress) * 500;
    } else if (element.animation === 'slideUp') {
      animY += (1 - animProgress) * 500;
    } else if (element.animation === 'slideDown') {
      animY -= (1 - animProgress) * 500;
    } else if (element.animation === 'zoomIn') {
      animScale *= 0.5 + animProgress * 0.5;
    } else if (element.animation === 'zoomOut') {
      animScale *= 1 + animProgress * 0.5;
    } else if (element.animation === 'rotate') {
      animRotate += animProgress * 360;
    }

    ctx.globalAlpha = animOpacity;
    ctx.translate(canvas.width / 2 + animX, canvas.height / 2 + animY);
    ctx.rotate(animRotate * Math.PI / 180);
    ctx.scale(animScale, animScale);

    if (element.type === 'image' && element.image) {
      const w = element.width;
      const h = element.height;
      ctx.drawImage(element.image, -w / 2, -h / 2, w, h);
    } else if (element.type === 'text') {
      ctx.font = `900 ${element.fontSize}px ${element.fontFamily}`;
      ctx.textAlign = 'center';
      ctx.textBaseline = 'middle';
      ctx.fillStyle = element.textColor;
      const lines = element.text.split('\n');
      lines.forEach((line, i) => {
        const yOffset = (i - (lines.length - 1) / 2) * element.fontSize * 1.2;
        ctx.fillText(line, 0, yOffset);
      });
    }

    ctx.restore();
  });
}

function addElement(type) {
  const id = Date.now();
  const element = {
    id,
    type,
    name: type === 'image' ? `Image ${getCurrentPage().elements.length + 1}` : `Text ${getCurrentPage().elements.length + 1}`,
    x: 0,
    y: 0,
    scale: 1,
    rotate: 0,
    opacity: 1,
    startTime: 0,
    duration: 5,
    animation: 'fadeIn',
    animSpeed: 1
  };

  if (type === 'image') {
    element.image = null;
    element.width = 540;
    element.height = 540;
  } else if (type === 'text') {
    element.text = 'YOUR TEXT';
    element.fontSize = 64;
    element.fontFamily = 'Arial';
    element.textColor = '#ffffff';
  }

  getCurrentPage().elements.push(element);
  selectElement(id);
  updateLayersList();
  updateTimeline();
  redraw();
}

function selectElement(id) {
  activeElementId = id;
  updateLayersList();
  updatePropertyPanel();
  updateTimeline();
}

function deleteElement() {
  if (!activeElementId) return;
  const page = getCurrentPage();
  page.elements = page.elements.filter(el => el.id !== activeElementId);
  activeElementId = null;
  updateLayersList();
  updatePropertyPanel();
  updateTimeline();
  redraw();
}

function updateLayersList() {
  const container = document.getElementById('layersList');
  const page = getCurrentPage();
  
  container.innerHTML = page.elements.map(element => `
    <div class="layer-item ${element.id === activeElementId ? 'active' : ''}" 
         onclick="selectElement(${element.id})">
      <span>${element.name}</span>
      <span class="layer-badge">${element.type}</span>
    </div>
  `).join('');
  
  document.getElementById('currentPageNum').textContent = currentPageIndex + 1;
}

function updatePropertyPanel() {
  const panel = document.getElementById('elementProperties');
  const imageProps = document.getElementById('imageProps');
  const textProps = document.getElementById('textProps');
  
  if (!activeElementId) {
    panel.style.display = 'none';
    return;
  }

  panel.style.display = 'block';
  const element = getCurrentPage().elements.find(el => el.id === activeElementId);
  
  imageProps.style.display = element.type === 'image' ? 'block' : 'none';
  textProps.style.display = element.type === 'text' ? 'block' : 'none';
  
  const bindings = [
    ['posX', 'x'],
    ['posY', 'y'],
    ['scale', 'scale'],
    ['rotate', 'rotate'],
    ['opacity', 'opacity'],
    ['startTime', 'startTime'],
    ['duration', 'duration'],
    ['animSpeed', 'animSpeed']
  ];

  if (element.type === 'image') {
    bindings.push(['imgWidth', 'width']);
    bindings.push(['imgHeight', 'height']);
    bindings.push(['imgOpacity', 'opacity']);
  } else if (element.type === 'text') {
    bindings.push(['fontSize', 'fontSize']);
  }

  bindings.forEach(([id, prop]) => {
    const el = document.getElementById(id);
    if (!el) return;
    el.value = element[prop];
    el.oninput = e => {
      element[prop] = Number(e.target.value);
      updatePropertyValues();
      updateTimeline();
      redraw();
    };
  });

  if (element.type === 'text') {
    const textContent = document.getElementById('textContent');
    const fontFamily = document.getElementById('fontFamily');
    const textColor = document.getElementById('textColor');
    
    textContent.value = element.text;
    fontFamily.value = element.fontFamily;
    textColor.value = element.textColor;
    
    textContent.oninput = e => {
      element.text = e.target.value;
      redraw();
    };
    
    fontFamily.onchange = e => {
      element.fontFamily = e.target.value;
      redraw();
    };
    
    textColor.oninput = e => {
      element.textColor = e.target.value;
      redraw();
    };
  }

  if (element.type === 'image') {
    document.getElementById('imageUpload').onchange = e => {
      const file = e.target.files[0];
      if (!file) return;
      const reader = new FileReader();
      reader.onload = () => {
        const img = new Image();
        img.onload = () => {
          element.image = img;
          redraw();
        };
        img.src = reader.result;
      };
      reader.readAsDataURL(file);
    };
  }

  updatePropertyValues();
}

function updatePropertyValues() {
  if (!activeElementId) return;
  const element = getCurrentPage().elements.find(el => el.id === activeElementId);
  if (!element) return;

  const updates = [
    ['posXVal', Math.round(element.x)],
    ['posYVal', Math.round(element.y)],
    ['scaleVal', element.scale.toFixed(2)],
    ['rotateVal', Math.round(element.rotate) + '¬∞'],
    ['opacityVal', Math.round(element.opacity * 100) + '%'],
    ['startTimeVal', element.startTime.toFixed(1)],
    ['durationVal', element.duration.toFixed(1)],
    ['animSpeedVal', element.animSpeed.toFixed(1)]
  ];

  if (element.type === 'image') {
    updates.push(['imgWidthVal', Math.round(element.width)]);
    updates.push(['imgHeightVal', Math.round(element.height)]);
    updates.push(['imgOpacityVal', Math.round(element.opacity * 100) + '%']);
  } else if (element.type === 'text') {
    updates.push(['fontSizeVal', Math.round(element.fontSize)]);
  }

  updates.forEach(([id, val]) => {
    const el = document.getElementById(id);
    if (el) el.textContent = val;
  });
}

function setAnimation(anim) {
  if (!activeElementId) return;
  const element = getCurrentPage().elements.find(el => el.id === activeElementId);
  if (!element) return;
  element.animation = anim;
  showToast(`Animation: ${anim}`);
}

function addPage() {
  pages.push({
    elements: [],
    duration: 5
  });
  updatePagesUI();
  updateTimeline();
  showToast('New page added');
}

function switchPage(index) {
  currentPageIndex = index;
  activeElementId = null;
  updatePagesUI();
  updateLayersList();
  updatePropertyPanel();
  updateTimeline();
  redraw();
}

function updatePagesUI() {
  const container = document.getElementById('pagesContainer');
  const pagesHTML = pages.map((page, i) => `
    <div class="page-thumb ${i === currentPageIndex ? 'active' : ''}" onclick="switchPage(${i})">
      <span>P${i + 1}</span>
      <div class="page-duration">${page.duration}s</div>
    </div>
  `).join('');
  
  container.innerHTML = pagesHTML + '<div class="add-page-btn" onclick="addPage()">+</div>';
}

function updateTimeline() {
  const container = document.getElementById('timelineTracks');
  const page = getCurrentPage();
  const pageDuration = page.duration;
  const pixelsPerSecond = 100;
  
  let tracksHTML = '';
  
  page.elements.forEach(element => {
    const left = element.startTime * pixelsPerSecond;
    const width = element.duration * pixelsPerSecond;
    const color = element.type === 'image' ? 'image' : 'text';
    const selected = element.id === activeElementId ? 'selected' : '';
    
    tracksHTML += `
      <div class="track">
        <div class="track-label">${element.name}</div>
        <div class="track-content">
          <div class="track-item ${color} ${selected}" 
               style="left: ${left}px; width: ${width}px;"
               data-id="${element.id}"
               onmousedown="startDragTimeline(event, ${element.id})">
            <div class="item-handle left"></div>
            <div class="item-name">${element.name}</div>
            <div class="item-duration">${element.duration.toFixed(1)}s</div>
            <div class="item-handle right"></div>
          </div>
        </div>
      </div>
    `;
  });
  
  if (musicLoaded) {
    tracksHTML += `
      <div class="track">
        <div class="track-label">Audio</div>
        <div class="track-content">
          <div class="track-item audio" style="left: 0px; width: ${pageDuration * pixelsPerSecond}px;">
            <div class="item-name">üéµ Music</div>
            <div class="item-duration">${pageDuration.toFixed(1)}s</div>
          </div>
        </div>
      </div>
    `;
  }
  
  container.innerHTML = tracksHTML;
}

function startDragTimeline(e, id) {
  e.stopPropagation();
  isDraggingTimeline = true;
  draggedItem = id;
  dragStartX = e.clientX;
  selectElement(id);
}

document.addEventListener('mousemove', e => {
  if (!isDraggingTimeline || !draggedItem) return;
  const element = getCurrentPage().elements.find(el => el.id === draggedItem);
  if (!element) return;
  
  const deltaX = e.clientX - dragStartX;
  const pixelsPerSecond = 100;
  const deltaTime = deltaX / pixelsPerSecond;
  
  element.startTime = Math.max(0, element.startTime + deltaTime);
  dragStartX = e.clientX;
  
  updateTimeline();
  updatePropertyValues();
  redraw();
});

document.addEventListener('mouseup', () => {
  isDraggingTimeline = false;
  draggedItem = null;
});

function loadMusic() {
  const url = document.getElementById('musicUrl').value.trim();
  if (!url) {
    showToast('Please enter a music URL');
    return;
  }
  
  audioPlayer.src = url;
  audioPlayer.load();
  audioPlayer.style.display = 'block';
  audioPlayer.onloadeddata = () => {
    musicLoaded = true;
    updateTimeline();
    showToast('Music loaded!');
  };
  audioPlayer.onerror = () => {
    showToast('Failed to load music');
  };
}

function setCanvasSize(w, h) {
  canvas.width = w;
  canvas.height = h;
  redraw();
}

function zoomIn() {
  zoomLevel = Math.min(zoomLevel + 0.1, 3);
  updateZoom();
}

function zoomOut() {
  zoomLevel = Math.max(zoomLevel - 0.1, 0.1);
  updateZoom();
}

function resetZoom() {
  zoomLevel = 1;
  updateZoom();
}

function updateZoom() {
  canvasWrapper.style.transform = `scale(${zoomLevel})`;
  document.getElementById('zoomLevel').textContent = Math.round(zoomLevel * 100) + '%';
}

function play() {
  if (isPlaying) return;
  isPlaying = true;
  
  const page = getCurrentPage();
  const fps = 30;
  
  if (musicLoaded) {
    audioPlayer.currentTime = 0;
    audioPlayer.play();
  }
  
  function animate() {
    if (!isPlaying) return;
    currentTime += 1 / fps;
    
    if (currentTime >= page.duration) {
      currentTime = 0;
      isPlaying = false;
      if (musicLoaded) audioPlayer.pause();
      return;
    }
    
    const mins = Math.floor(currentTime / 60);
    const secs = Math.floor(currentTime % 60);
    const totalMins = Math.floor(page.duration / 60);
    const totalSecs = Math.floor(page.duration % 60);
    
    document.getElementById('timeDisplay').textContent = 
      `${mins.toString().padStart(2, '0')}:${secs.toString().padStart(2, '0')} / ${totalMins.toString().padStart(2, '0')}:${totalSecs.toString().padStart(2, '0')}`;
    
    redraw();
    animationId = requestAnimationFrame(animate);
  }
  
  animate();
}

function pause() {
  isPlaying = false;
  if (animationId) cancelAnimationFrame(animationId);
  if (musicLoaded) audioPlayer.pause();
}

function reset() {
  pause();
  currentTime = 0;
  const page = getCurrentPage();
  const mins = Math.floor(page.duration / 60);
  const secs = Math.floor(page.duration % 60);
  document.getElementById('timeDisplay').textContent = `00:00 / ${mins.toString().padStart(2, '0')}:${secs.toString().padStart(2, '0')}`;
  if (musicLoaded) audioPlayer.currentTime = 0;
  redraw();
}

function showToast(message) {
  const toast = document.getElementById('statusToast');
  document.getElementById('statusText').textContent = message;
  toast.classList.add('show');
  setTimeout(() => toast.classList.remove('show'), 2000);
}

async function exportAllPages() {
  showToast('Rendering video...');
  
  const fps = 30;
  let totalDuration = 0;
  
  pages.forEach(page => {
    totalDuration += page.duration;
  });
  
  const totalFrames = fps * totalDuration;

  try {
    const stream = canvas.captureStream(fps);
    let finalStream = stream;
    
    if (musicLoaded) {
      const audioCtx = new AudioContext();
      const dest = audioCtx.createMediaStreamDestination();
      const source = audioCtx.createMediaElementSource(audioPlayer);
      source.connect(dest);
      source.connect(audioCtx.destination);
      
      const audioTrack = dest.stream.getAudioTracks()[0];
      const videoTrack = stream.getVideoTracks()[0];
      finalStream = new MediaStream([videoTrack, audioTrack]);
    }
    
    const recorder = new MediaRecorder(finalStream, {
      mimeType: 'video/webm;codecs=vp9,opus',
      videoBitsPerSecond: 5000000
    });
    
    const chunks = [];
    recorder.ondataavailable = e => chunks.push(e.data);
    
    recorder.start();
    
    if (musicLoaded) {
      audioPlayer.currentTime = 0;
      audioPlayer.play();
    }

    let globalTime = 0;
    
    for (let pageIdx = 0; pageIdx < pages.length; pageIdx++) {
      const page = pages[pageIdx];
      const pageFrames = fps * page.duration;
      
      for (let i = 0; i < pageFrames; i++) {
        currentTime = i / fps;
        
        const originalPage = currentPageIndex;
        currentPageIndex = pageIdx;
        
        redraw();
        
        currentPageIndex = originalPage;
        
        await new Promise(resolve => setTimeout(resolve, 1000 / fps));
      }
    }

    if (musicLoaded) audioPlayer.pause();
    recorder.stop();
    
    recorder.onstop = () => {
      const blob = new Blob(chunks, { type: 'video/webm' });
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a');
      a.href = url;
      a.download = `video-${Date.now()}.webm`;
      a.click();
      URL.revokeObjectURL(url);
      
      reset();
      showToast(`Exported ${totalDuration.toFixed(1)}s video!`);
    };
  } catch (error) {
    showToast('Export failed');
    console.error(error);
  }
}

document.getElementById('bgColor').oninput = redraw;
document.getElementById('canvasSizeSelect').onchange = e => {
  const [w, h] = e.target.value.split(',').map(Number);
  setCanvasSize(w, h);
};

document.getElementById('pageDuration').oninput = e => {
  getCurrentPage().duration = Number(e.target.value);
  updatePagesUI();
  updateTimeline();
};
</script>

</body>
</html>
